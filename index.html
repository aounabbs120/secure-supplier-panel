
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SJ10 - Supplier Panel</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #4f46e5; --secondary-color: #f3f4f6; --text-dark: #1f2937;
      --text-light: #6b7280; --border-color: #e5e7eb; --white: #ffffff;
      --danger: #ef4444; --success: #16a34a; --info: #3b82f6; --warning: #f97316;
      --shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
      --whatsapp-green: #dcf8c6;
      --whatsapp-bg: #e5ddd5;
    }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; color: var(--text-dark); -webkit-font-smoothing: antialiased; }
    body.app-visible { overflow: hidden; }
    .auth-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(45deg, #4f46e5, #3b82f6, #ef4444, #f97316); background-size: 400% 400%; animation: gradient-animation 15s ease infinite; z-index: -1; }
    @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .auth-page { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; transition: opacity 0.3s ease; overflow-y: auto; padding: 40px 20px; }
    
    .brand-logo { width: auto; object-fit: contain; }
    .auth-logo { max-height: 120px; margin-bottom: 2rem; }
    .sidebar-logo { max-height: 70px; }

    .auth-form { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2); padding: 30px 40px; width: 100%; max-width: 600px; animation: fadeIn 0.5s ease-out; margin: 20px 0; }
    .auth-form h2 { color: white; text-align: center; margin-top: 0; }
    .form-group label { color: white; font-weight: 500; margin-bottom: 6px; display: block; }
    .form-group input, .form-group select, .form-group textarea { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; width: 100%; padding: 12px; border-radius: 8px; box-sizing: border-box; }
    .form-group input::placeholder { color: rgba(255,255,255,0.7); }
    .form-group select option { color: var(--text-dark); background: var(--white); }
    .btn-animated { position: relative; overflow: hidden; z-index: 1; }
    .btn-animated::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transition: left 0.6s ease; z-index: -1; }
    .btn-animated:hover::before { left: 100%; }
    #app-wrapper { display: none; opacity: 0; transition: opacity 0.5s ease; overflow: auto; height: 100vh; background-color: var(--secondary-color); }
    .app-flex-container { display: flex; }
    .sidebar { width: 260px; background-color: var(--text-dark); color: var(--white); height: 100vh; position: fixed; top: 0; left: 0; z-index: 100; display: flex; flex-direction: column; transition: transform 0.3s ease-in-out; }
    .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .sidebar-menu { list-style: none; padding: 0; margin: 20px 0; flex-grow: 1; overflow:auto; }
    .sidebar-menu li a { position: relative; display: block; padding: 15px 24px; color: #aeb1b8; text-decoration: none; font-weight: 500; border-left: 4px solid transparent; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    .sidebar-menu li a:hover { background-color: rgba(255,255,255,0.05); color: var(--white); border-left-color: var(--primary-color); transform: translateX(5px); }
    .sidebar-menu li a.active { background-color: var(--primary-color); color: var(--white); border-left-color: #a5b4fc; box-shadow: 0 0 15px rgba(79, 70, 229, 0.5); font-weight: 600; }
    .notification-dot { height: 8px; width: 8px; background-color: var(--danger); border-radius: 50%; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: none; }
    .sidebar-footer { padding: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.04); }
    .main-content { margin-left: 260px; flex-grow: 1; padding: 32px; position: relative; }
    .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
    .main-header { font-size: 2.25rem; font-weight: 800; }
    .page { display: none; }
    .page.active { display: block; animation: page-fade-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    @keyframes page-fade-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .content-table { width: 100%; border-collapse: collapse; background-color: var(--white); box-shadow: var(--shadow); border-radius: 8px; overflow: hidden; margin-bottom: 32px; }
    .content-table th, .content-table td { padding: 14px; text-align:left; vertical-align: middle; }
    .content-table thead { background-color: var(--secondary-color); }
    .content-table tbody tr { border-bottom: 1px solid var(--border-color); transition: all 0.2s ease-out; }
    .content-table tbody tr:hover { background-color: #f9fafb; transform: scale(1.01); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    .product-thumbnail { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; background-color: var(--border-color); }
    .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); text-transform: uppercase; font-size: 0.78rem; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.12); }
    .btn:disabled { cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
    .btn i.fa-spin { margin-right: 8px; }
    .btn-primary { background: linear-gradient(90deg,var(--primary-color), #6366f1); color: white; }
    .btn-secondary { background: var(--white); border: 1px solid var(--border-color); color: var(--text-dark); }
    .btn-delete { background: linear-gradient(90deg, #ef4444, #f97316); color: white; }
    .btn-edit { background: linear-gradient(90deg, var(--info), #60a5fa); color: white; margin-right:8px; }
    .btn-view { background: linear-gradient(90deg, var(--info), #60a5fa); color: white; }
    .btn-warning { background: linear-gradient(90deg, var(--warning), #fbbf24); color: white; }
    .btn-success { background: linear-gradient(90deg, var(--success), #4ade80); color: white; }
    .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index:1000; display:none; justify-content:center; align-items:center; transition: opacity 0.3s ease; }
    .modal { background-color: var(--white); padding: 28px; border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y:auto; transform: scale(0.95); opacity: 0; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .modal-overlay.visible .modal { transform: scale(1); opacity: 1; }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap: 20px; }
    .form-group { margin-bottom: 0; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-group label { color: var(--text-dark); font-weight: 600; margin-bottom: 8px; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; box-sizing:border-box; background: var(--white); color: var(--text-dark); }
    
    #image-previews { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; padding: 12px; border: 2px dashed var(--border-color); border-radius: 8px; min-height: 140px; background-color: #f9fafb; }
    .preview-image-container { position: relative; width: 110px; height: 110px; flex-shrink: 0; }
    .preview-image { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color); }
    .delete-preview-btn { position: absolute; top: -10px; right: -10px; background: var(--danger); color: white; border: 2px solid var(--white); border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    .payment-options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center; }
    .payment-option-card { border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s ease; }
    .payment-option-card:hover { border-color: var(--primary-color); transform: translateY(-5px); box-shadow: var(--shadow); }
    .payment-option-card img { max-height: 60px; margin-bottom: 10px; }
    .add-payment-card { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; }
    .add-payment-card i { font-size: 3rem; color: var(--primary-color); margin-bottom: 10px; }
    .order-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .order-details-grid .card h4 { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; }
    .order-details-products { grid-column: 1 / -1; }
    .order-product-item { display: flex; gap: 15px; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
    .order-product-item:last-child { border-bottom: none; }
    .order-product-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
    .order-product-details { flex-grow: 1; }
    .order-product-details p { margin: 4px 0; color: var(--text-light); }
    .order-status-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }

    .card { background-color: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 18px; transition: all 0.2s ease-out; }
    .card:hover { box-shadow: 0 8px 16px rgba(15, 23, 42, 0.1); }
    .dashboard-cards-container { display: flex; flex-wrap: wrap; gap: 16px; }
    .dashboard-cards-container .card { flex: 1; min-width: 200px; text-align: center; opacity: 0; animation: card-fade-in 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .dashboard-cards-container .card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(15, 23, 42, 0.1); }
    .dashboard-cards-container .card h3 { margin-top: 0; }
    .dashboard-cards-container .card p { font-size: 2.5rem; font-weight: bold; margin: 0; transition: color 0.3s ease; }
    .dashboard-cards-container .card.highlight p { animation: highlight-pop 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes highlight-pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); color: var(--primary-color); } 100% { transform: scale(1); } }
    @keyframes card-fade-in { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }
    .dashboard-cards-container .card:nth-child(1) { animation-delay: 0.1s; }
    .dashboard-cards-container .card:nth-child(2) { animation-delay: 0.2s; }
    .dashboard-cards-container .card:nth-child(3) { animation-delay: 0.3s; }
    .dashboard-cards-container .card:nth-child(4) { animation-delay: 0.4s; }
    
    .auth-toggle { text-align: center; margin-top: 16px; color: white; }
    .auth-toggle a { color: white; cursor: pointer; font-weight: bold; }
    .error-message, .success-message { padding: 10px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid; }
    .error-message { background: rgba(239, 68, 68, 0.1); border-color: #f87171; color: #b91c1c; }
    #auth-page .error-message { background: rgba(159, 18, 57, 0.3); color: white; }
    .success-message { background: rgba(34, 197, 94, 0.1); border-color: #22c55e; color: #14532d; }
    .mobile-header { display: none; align-items: center; justify-content: space-between; padding: 10px 20px; background-color: var(--white); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 90; }
    .menu-toggle { background: none; border: none; cursor: pointer; padding: 10px; }
    .menu-toggle .bar { display: block; width: 25px; height: 3px; background-color: var(--text-dark); margin: 5px 0; transition: 0.3s; }
    
    #chat-list-container { width: 100%; }
    .conversation-list { list-style: none; padding: 0; margin: 0; }
    .conversation-item { display: flex; align-items: center; padding: 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease; }
    .conversation-item:hover { background-color: var(--secondary-color); }
    .conversation-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; margin-right: 15px; flex-shrink: 0; overflow: hidden; }
    .conversation-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .conversation-details { flex-grow: 1; overflow: hidden; }
    .conversation-name { font-weight: 600; font-size: 1.1em; margin-bottom: 4px; }
    .conversation-last-message { font-size: 0.9em; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .unread-badge { background: var(--success); color: white; border-radius: 50%; min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; }

    #chat-detail-container { display: none; flex-direction: column; height: 80vh; width: 100%; background: var(--white); border-radius: 12px; overflow: hidden; }
    .chat-detail-header { display: flex; align-items: center; padding: 10px 15px; background-color: var(--secondary-color); border-bottom: 1px solid var(--border-color); cursor: pointer; }
    .chat-back-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; margin-right: 15px; }
    .chat-detail-header h3 { margin: 0; font-size: 1.2rem; }

    .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background-color: var(--whatsapp-bg); }
    .message-wrapper { display: flex; flex-direction: column; }
    .message { max-width: 70%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; position: relative; animation: message-fade-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    @keyframes message-fade-in { from { opacity: 0; transform: translateY(12px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .message.sent-by-supplier { background-color: var(--whatsapp-green); color: var(--text-dark); align-self: flex-end; border-bottom-right-radius: 4px; }
    .message.received-from-user { background-color: var(--white); color: var(--text-dark); align-self: flex-start; border-bottom-left-radius: 4px; }

    .message-content { padding-bottom: 18px; white-space: pre-wrap; word-wrap: break-word; }
    .message-meta { position: absolute; bottom: 5px; right: 10px; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; }
    .sent-by-supplier .message-meta { color: rgba(0,0,0,0.4); }
    .received-from-user .message-meta { color: rgba(0,0,0,0.4); }
    .message-ticks { font-size: 1rem; }
    .message-ticks.seen { color: #34b7f1; }

    .date-separator { text-align: center; margin: 15px 0; }
    .date-separator span { background-color: #e1f2fb; color: #5e5e5e; padding: 5px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 500; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }

    .chat-input-area { display: flex; padding: 15px; border-top: 1px solid var(--border-color); background: var(--secondary-color); }
    #message-input { flex-grow: 1; padding: 12px 20px; border: 1px solid var(--border-color); border-radius: 25px; margin-right: 10px; }
    #message-input:focus { outline: none; border-color: var(--primary-color); }
    .send-btn { background-color: var(--primary-color); color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    
    #loader-overlay { background-color: rgba(255, 255, 255, 0.8); z-index: 9999; }
    .loader-spinner { width: 60px; height: 60px; border: 6px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .confirmation-modal { background-color: var(--white); padding: 28px 32px; border-radius: 16px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(0.9); opacity: 0; transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); }
    #confirmation-modal-overlay.visible .confirmation-modal { transform: scale(1); opacity: 1; }
    .confirmation-modal h3 { margin-top: 0; font-size: 1.5rem; color: var(--text-dark); }
    .confirmation-modal p { color: var(--text-light); margin: 10px 0 25px; font-size: 1.1rem; }
    .confirmation-buttons { display: flex; justify-content: center; gap: 15px; }
    .confirmation-buttons .btn { width: 120px; }
    
    .profile-pic-uploader { position: relative; width: 120px; height: 120px; margin: 0 auto 1.5rem; }
    .profile-pic-preview { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); background-color: var(--secondary-color); }
    .profile-pic-placeholder { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; border-radius: 50%; background-color: var(--primary-color); color: white; font-size: 3rem; font-weight: bold; border: 4px solid var(--border-color); }
    #account .profile-pic-uploader .profile-pic-preview { border: none; } 
    #account .profile-pic-uploader { width: 128px; height: 128px; }
    .verification-badge { position: absolute; bottom: 2px; right: 2px; width: 40px; height: 40px; z-index: 2; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .verification-badge.verified-badge { background: linear-gradient(45deg, #22c55e, #4ade80); animation: badge-glow 2s infinite alternate; }
    .verification-badge.unverified-badge { background-color: var(--danger); }
    .verification-badge.under-review-badge { background-color: var(--warning); animation: pulse-warning 1.5s infinite; }
    @keyframes badge-glow { from { box-shadow: 0 0 5px #4ade80, 0 0 10px #4ade80; } to { box-shadow: 0 0 20px #22c55e, 0 0 30px #22c55e; } }
    @keyframes pulse-warning { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 10px 15px rgba(249, 115, 22, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
    #signup-form .profile-pic-uploader .profile-pic-preview { border-color: rgba(255,255,255,0.3); }
    #signup-form .profile-pic-placeholder { background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); }
    .profile-pic-uploader label { position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; background: white; color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); border: 2px solid white; z-index: 2;}
    .profile-pic-uploader input[type="file"] { display: none; }
    
    @keyframes animated-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .animated-gradient-border { position: relative; padding: 4px; border-radius: 50%; overflow: visible; }
    .animated-gradient-border::before { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; z-index: 0; margin: -4px; border-radius: inherit; background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff00ff); background-size: 400% 400%; animation: animated-gradient 3s linear infinite; }
    .animated-gradient-border > img, .animated-gradient-border > div { position: relative; z-index: 1; }
    .conversation-item .animated-gradient-border { padding: 2px; margin-right: 15px; width: 54px; height: 54px; flex-shrink: 0; }
    .conversation-item .animated-gradient-border::before { margin: -2px; }
    .conversation-item .conversation-avatar { margin: 0; width: 100%; height: 100%; font-size: 1.5rem; }
    
    #variant-modal .modal { max-width: 1200px; width: 95%; }
    .variant-layout { display: grid; grid-template-columns: 350px 1fr; gap: 24px; }
    .variant-steps { display: flex; flex-direction: column; gap: 20px; }
    .variant-step { background: var(--secondary-color); border-radius: 12px; padding: 20px; animation: fadeIn 0.4s ease forwards; opacity: 0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .variant-step h3 { margin-top: 0; color: var(--primary-color); font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
    #color-search { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 12px; }
    #color-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; max-height: 250px; overflow-y: auto; padding: 10px; background-color: var(--white); border-radius: 8px; }
    .color-item { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; }
    .color-item:hover { background-color: #eef2ff; }
    .color-item.selected { background-color: #e0e7ff; border-color: var(--primary-color); font-weight: 600; }
    .color-swatch { width: 24px; height: 24px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }
    .color-name { font-size: 0.9em; }
    .variant-results { background: var(--white); border-radius: 12px; padding: 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    .variant-results h3 { margin-top: 0; }
    #current-variants-list table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    #current-variants-list th, #current-variants-list td { padding: 12px 10px; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
    #current-variants-list th { background-color: var(--secondary-color); font-size: 0.9rem; }
    #current-variants-list td { font-size: 0.95rem; }
    .variant-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; align-items: flex-end; }

    .reviews-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .review-card { background-color: var(--white); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); cursor: pointer; transition: all 0.2s ease-out; }
    .review-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(15, 23, 42, 0.1); }
    .review-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .review-product-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
    .review-product-name { font-weight: 600; font-size: 1.1rem; }
    .star-rating { color: #f59e0b; margin-bottom: 10px; font-size: 1.1rem; }
    .review-comment { color: var(--text-light); font-style: italic; border-left: 3px solid var(--border-color); padding-left: 15px; margin-bottom: 15px; }
    .review-customer-img { width: 100%; max-width: 150px; height: auto; object-fit: cover; border-radius: 8px; margin-top: 10px; }
    #review-detail-modal .modal { max-width: 1000px; }
    .review-detail-layout { display: grid; grid-template-columns: 300px 1fr; gap: 24px; }
    .review-detail-product-card img { width: 100%; border-radius: 8px; margin-bottom: 15px; }
    .review-detail-product-card h4 { margin-top: 0; }
    .review-detail-product-card p { font-size: 0.9rem; color: var(--text-light); max-height: 100px; overflow-y: auto; }
    .all-reviews-list .review-item { padding: 15px 0; border-bottom: 1px solid var(--border-color); }
    .all-reviews-list .review-item:last-child { border-bottom: none; }
    .all-reviews-list .review-item .review-comment { border: none; padding-left: 0; margin-top: 8px; }

    .dashboard-charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px; }

    .earnings-summary-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    .summary-card { padding: 24px; border-radius: 12px; color: var(--white); }
    .summary-card h3 { margin-top: 0; opacity: 0.8; }
    .summary-card p { font-size: 2.5rem; font-weight: bold; margin: 0; }
    .summary-card.paid { background: linear-gradient(45deg, var(--success), #22c55e); }
    .summary-card.balance { background: linear-gradient(45deg, var(--info), #60a5fa); }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: white; text-transform: capitalize; }
    .status-badge.Processing, .status-badge.pending, .status-badge.pending-approval { background-color: var(--warning); }
    .status-badge.successful, .status-badge.active { background-color: var(--success); }
    .status-badge.canceled, .status-badge.rejected { background-color: var(--danger); }
    .status-badge.awaiting-payment, .status-badge.approved-awaiting-payment { background-color: var(--info); }
    .status-badge.expired { background-color: var(--text-light); }
    
    .whatsapp-fab {
      position: fixed;
      top: 85%;
      left: 90%;
      width: 60px;
      height: 60px;
      background-color: #25D366;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 1100;
      text-decoration: none;
      animation: whatsapp-pulse 2s infinite;
      transition: transform 0.3s ease;
      cursor: grab;
      user-select: none;
    }
    .whatsapp-fab:active {
        cursor: grabbing;
    }
    .whatsapp-fab:hover {
      transform: scale(1.1);
      animation-play-state: paused;
    }
    @keyframes whatsapp-pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(37, 211, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }

    .dashboard-social-icons { display: flex; justify-content: center; gap: 20px; margin-bottom: 24px; }
    .social-icon-link { display: flex; align-items: center; justify-content: center; width: 60px; height: 60px; border-radius: 18px; color: white; font-size: 1.8rem; text-decoration: none; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    .social-icon-link:hover { transform: translateY(-8px) scale(1.1); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .social-icon-facebook { background: linear-gradient(45deg, #1877f2, #3b5998); }
    .social-icon-youtube { background: linear-gradient(45deg, #ff0000, #c4302b); }
    .social-icon-instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }

    .sidebar-social-icons { padding: 10px 20px; display: flex; justify-content: space-around; align-items: center; }
    .sidebar-social-link { color: #aeb1b8; font-size: 1.5rem; transition: color 0.3s, transform 0.3s; animation: sidebar-icon-shake 5s infinite; }
    .sidebar-social-link:hover { transform: scale(1.2); animation-play-state: paused; }
    .sidebar-social-link.facebook:hover { color: #1877f2; }
    .sidebar-social-link.youtube:hover { color: #ff0000; }
    .sidebar-social-link.instagram:hover { color: #e1306c; }
    .sidebar-social-link:nth-child(2) { animation-delay: 0.2s; }
    .sidebar-social-link:nth-child(3) { animation-delay: 0.4s; }
    @keyframes sidebar-icon-shake { 0%, 10%, 100% { transform: rotate(0); } 2%, 6% { transform: rotate(-15deg); } 4%, 8% { transform: rotate(15deg); } }
    
    #attributes-section { grid-column: 1 / -1; border-top: 2px solid var(--border-color); padding-top: 20px; margin-top: 15px; display: flex; align-items: center; gap: 15px; }
    #attributes-status { font-style: italic; color: var(--text-light); }
    #attributes-modal .modal { max-width: 1100px; }
    #attributes-modal-content h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
    .attributes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px 24px; }
    .attributes-grid .form-group { opacity: 0; animation: fadeIn 0.4s ease-out forwards; }
    .measurement-group { display: flex; gap: 10px; align-items: center; }
    .measurement-group input { flex-grow: 1; }
    .measurement-group select { width: 100px; }
    .custom-attribute-pair { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
    .custom-attribute-pair input { flex: 1; }
    #payment .add-account-container { text-align: center; padding: 50px 20px; }
    #payment .add-account-container i { font-size: 4rem; color: var(--primary-color); margin-bottom: 20px; }

    /* --- PROMOTION STYLES START --- */
    .promotion-steps-container { position: relative; padding-top: 20px; }
    .promotion-step-content { display: none; }
    .promotion-step-content.active { display: block; animation: page-fade-in 0.5s; }
    .product-selection-list { max-height: 400px; overflow-y: auto; padding: 10px; background-color: var(--secondary-color); border-radius: 8px; }
    .product-selection-item { display: flex; align-items: center; padding: 12px; background-color: var(--white); border-radius: 8px; margin-bottom: 10px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s ease; }
    .product-selection-item:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
    .product-selection-item.selected { border-color: var(--primary-color); background-color: #eef2ff; }
    .product-selection-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; margin-right: 15px; }
    .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
    .pricing-card { border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s ease-out; }
    .pricing-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
    .pricing-card.selected { border-color: var(--primary-color); background-color: #eef2ff; box-shadow: 0 0 15px rgba(79, 70, 229, 0.3); }
    .pricing-card h4 { margin: 0 0 5px 0; color: var(--primary-color); }
    .pricing-card p { margin: 0; font-size: 1.5rem; font-weight: 700; }
    .confirmation-summary { background-color: var(--secondary-color); padding: 20px; border-radius: 12px; }
    .confirmation-summary h4 { margin-top: 0; }
    .confirmation-summary p { margin: 8px 0; }
    .payment-account-card { background: var(--white); border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--primary-color); text-align: left; box-shadow: var(--shadow); opacity: 0; animation: card-fade-in 0.5s ease-out forwards; }
    .payment-account-card h3 { margin: 0 0 10px; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
    .payment-account-card p { margin: 5px 0; font-size: 1.1rem; }
    .payment-account-card p strong { color: var(--text-dark); }
    .important-notice { background-color: #fffbeb; border: 1px solid #fde68a; color: #b45309; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left; opacity: 0; animation: card-fade-in 0.5s 0.3s ease-out forwards;}
    .important-notice p { margin: 0; }
    .important-notice strong { color: #92400e; }
    .promotion-important-note {
        padding: 15px 20px;
        background: linear-gradient(45deg, #fffbeb, #fef3c7);
        border-left: 5px solid #f59e0b;
        border-radius: 8px;
        margin-bottom: 24px;
        color: #92400e;
        animation: pulse-bg 3s infinite;
    }
    @keyframes pulse-bg { 0%, 100% { background-color: #fffbeb; } 50% { background-color: #fef9c3; } }
    #payment-info-modal .modal-content { text-align: center; }
    #payment-info-modal .payment-account-card:nth-of-type(2) { animation-delay: 0.15s; }
    #promotion-detail-modal-content { display: flex; flex-direction: column; gap: 15px; }
    #promotion-detail-modal-content .detail-row { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
    #promotion-detail-modal-content .detail-row:last-child { border-bottom: none; }
    #promotion-detail-modal-content .detail-label { font-weight: 600; color: var(--text-light); }
    .content-table .btn { margin: 2px; }
    /* --- PROMOTION STYLES END --- */

    /* --- CHAT & PROFILE STYLES START --- */
    .conversation-avatar, .chat-detail-header .conversation-avatar { cursor: pointer; }
    .page-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--secondary-color); z-index: 2000; animation: page-fade-in 0.4s; }
    .user-profile-page { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 20px; }
    .profile-page-header { position: absolute; top: 20px; left: 20px; }
    .profile-pic-large-container { position: relative; width: 200px; height: 200px; margin-bottom: 24px; cursor: pointer; }
    .profile-pic-large-container::before { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; z-index: -1; margin: -5px; border-radius: 50%; background: linear-gradient(45deg, #00ffff, #ff00ff, #00ffff); background-size: 400% 400%; animation: animated-gradient 3s linear infinite, neon-glow 1.5s infinite alternate; }
    @keyframes neon-glow { from { filter: blur(5px); } to { filter: blur(15px); } }
    .profile-pic-large { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 5px solid var(--white); box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    .user-profile-name { font-size: 2rem; font-weight: 700; color: var(--text-dark); }

    .image-zoom-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 3000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s; }
    .image-zoom-overlay.visible { opacity: 1; visibility: visible; }
    .image-zoom-content { position: relative; max-width: 90vw; max-height: 90vh; transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .image-zoom-overlay.visible .image-zoom-content { transform: scale(1); }
    .image-zoom-content img { display: block; width: 100%; height: 100%; max-width: 90vw; max-height: 90vh; object-fit: contain; cursor: zoom-in; transition: transform 0.3s ease; }
    .image-zoom-content img.zoomed { transform: scale(1.5); cursor: zoom-out; }
    .image-zoom-close-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; }
    /* --- CHAT & PROFILE STYLES END --- */
    
    /* --- NEW ORDER & DISPATCH STYLES --- */
    .copy-icon { cursor: pointer; margin-left: 8px; color: var(--primary-color); transition: color 0.2s; }
    .copy-icon:hover { color: var(--info); }
    .copy-feedback { margin-left: 8px; color: var(--success); font-weight: bold; font-size: 0.9em; }
    .dispatch-details { grid-column: 1 / -1; }
    .courier-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .courier-option { border: 2px solid var(--border-color); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s ease-out; }
    .courier-option:hover { box-shadow: var(--shadow); transform: translateY(-3px); }
    .courier-option.selected { border-color: var(--primary-color); background-color: #eef2ff; box-shadow: 0 0 15px rgba(79, 70, 229, 0.3); }
    .courier-option img { max-width: 100%; height: 60px; object-fit: contain; margin-bottom: 10px; }
    /* --- END NEW ORDER & DISPATCH STYLES --- */

    @media (max-width: 1024px) {
        .dashboard-charts-container { grid-template-columns: 1fr; }
    }
    @media (max-width: 900px) {
        .variant-layout { grid-template-columns: 1fr; }
        .review-detail-layout { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      body { overflow: auto; }
      .sidebar { transform: translateX(-100%); z-index: 1000; }
      .sidebar.is-open { transform: translateX(0); }
      .main-content { margin-left: 0; padding: 16px; }
      .mobile-header { display: flex; }
      .main-header { font-size: 1.8rem; }
      .page-header { flex-direction: column; align-items: flex-start; gap: 12px; }
      .auth-form { padding: 20px; max-width: 100%; }
      .form-grid, .attributes-grid { grid-template-columns: 1fr; }
      .form-group.full-width { grid-column: auto; }
      .modal { padding: 16px; width: 95%; }

      .content-table { border: none; box-shadow: none; }
      .content-table thead { display: none; }
      .content-table tr { display: block; border-bottom: 2px solid var(--primary-color); margin-bottom: 20px; background: var(--white); box-shadow: var(--shadow); border-radius: 8px; padding: 10px; }
      .content-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; border-bottom: 1px solid var(--border-color); padding: 12px 5px; }
      .content-table td:last-child { border-bottom: none; }
      .content-table td::before { content: attr(data-label); font-weight: bold; text-align: left; margin-right: 15px; color: var(--primary-color); }
      .product-thumbnail { margin-left: auto; }
      .btn-edit, .btn-delete, .btn-view { width: 100%; margin: 4px 0; }
      .content-table td[data-label="Actions"] { display: flex; flex-direction: column; gap: 8px; }
      
      .dashboard-cards-container .card { min-width: 100%; }
      .order-details-grid { grid-template-columns: 1fr; }
      .earnings-summary-container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="auth-bg"></div>

  <div id="auth-page" class="auth-page">
      <img src="logo.gif" alt="SJ10 Logo" class="brand-logo auth-logo">
      
      <form id="login-form" class="auth-form" style="max-width: 420px;">
        <h2>Supplier Login</h2>
        <div id="login-error" class="error-message" style="display:none;"></div>
        <div class="form-group"><label for="email">Email</label><input type="email" id="email" required></div>
        <div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div>
        <button type="submit" class="btn btn-primary btn-animated" style="width:100%;">Login</button>
        <div class="auth-toggle"><p>Don't have an account? <a id="show-signup-btn">Sign Up</a></p></div>
      </form>

      <form id="signup-form" class="auth-form" style="display:none;">
        <h2>Become a Supplier</h2>
        <div id="signup-error" class="error-message" style="display:none;"></div>
        
        <div class="profile-pic-uploader">
            <img id="signup-profile-pic-preview" class="profile-pic-preview" src="#" alt="Profile Preview" style="display:none;">
            <div id="signup-profile-pic-placeholder" class="profile-pic-placeholder"><i class="fas fa-user"></i></div>
            <label for="signup-profile-pic-file"><i class="fas fa-camera"></i></label>
            <input type="file" id="signup-profile-pic-file" accept="image/*" onchange="previewProfileImage(this, 'signup-profile-pic-preview')" required>
        </div>

        <div class="form-grid">
            <div class="form-group"><label for="signup-fullname">Full Name</label><input type="text" id="signup-fullname" required></div>
            <div class="form-group"><label for="signup-brand-name">Brand Name</label><input type="text" id="signup-brand-name" required></div>
            <div class="form-group"><label for="signup-email">Email</label><input type="email" id="signup-email" required></div>
            <div class="form-group"><label for="signup-password">Password (min. 6 characters)</label><input type="password" id="signup-password" required></div>
            <div class="form-group"><label for="signup-contact">Phone Number (e.g., +923123456789)</label><input type="text" id="signup-contact" placeholder="+923123456789" pattern="^\+92[0-9]{10}$" required></div>
            <div class="form-group"><label for="signup-age">Age</label><select id="signup-age" required></select></div>
            <div class="form-group full-width"><label for="signup-city">City</label><select id="signup-city" required></select></div>
            <div class="form-group"><label for="signup-address">Address</label><input type="text" id="signup-address" required></div>
            <div class="form-group"><label for="signup-street-no">Street No.</label><input type="text" id="signup-street-no" required></div>
            <div class="form-group"><label for="business-type">Business Type</label>
                <select id="business-type" required>
                    <option value="">Select Type...</option><option value="Retailer">Retailer</option><option value="Wholesaler">Wholesaler</option><option value="Manufacturer">Manufacturer</option><option value="Home Made">Home Made</option>
                </select>
            </div>
            <div class="form-group"><label for="stock-quantity">Stock Quantity</label>
                <select id="stock-quantity" required>
                    <option value="">Select Range...</option><option value="0-50">0 - 50 Products</option><option value="50-1000">50 - 1,000 Products</option><option value="1000+">1,000+ Products</option>
                </select>
            </div>
            <div class="form-group full-width"><label for="business-gender">Business Gender</label>
                <select id="business-gender" required>
                    <option value="">Select Gender...</option>
                    <option value="men">Men üëî</option>
                    <option value="women">Women üë©‚Äçü∞∞</option>
                    <option value="unisex">Unisex ‚öñÔ∏è</option>
                </select>
            </div>
            <div class="form-group full-width"><label>Main Categories (Select up to 2)</label><div id="signup-category-checkboxes" class="category-checkbox-group"></div></div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-animated" style="width:100%; margin-top: 1rem;">Create Account</button>
        <div class="auth-toggle"><p>Already have an account? <a id="show-login-btn">Login</a></p></div>
      </form>
      
      <div id="success-message-container" class="auth-form" style="display:none; max-width: 500px;">
          <div class="success-message" id="success-message-content" style="background: rgba(74, 222, 128, 0.2); color: white;"></div>
      </div>
  </div>

  <div id="app-wrapper">
    <div class="app-flex-container">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header" id="sidebar-header">
            <img src="logo.gif" alt="SJ10 Logo" class="brand-logo sidebar-logo">
        </div>
        <ul class="sidebar-menu">
          <li><a href="#dashboard" class="nav-link">Dashboard</a></li>
          <li><a href="#products" class="nav-link">My Products</a></li>
          <li><a href="#orders" class="nav-link">My Orders<span class="notification-dot"></span></a></li>
          <li><a href="#promotions" class="nav-link">Promotions</a></li>
          <li><a href="#reviews" class="nav-link">Reviews</a></li>
          <li><a href="#chat" class="nav-link">Chat with Users<span class="notification-dot"></span></a></li>
          <li><a href="#account" class="nav-link">Your Account</a></li>
          <li><a href="#payment" class="nav-link">Payment Info</a></li>
        </ul>
        <div class="sidebar-social-icons">
            <a href="https://www.facebook.com/share/1A6fShxiZf/" target="_blank" class="sidebar-social-link facebook"><i class="fab fa-facebook"></i></a>
            <a href="https://www.youtube.com/@Brandyt120" target="_blank" class="sidebar-social-link youtube"><i class="fab fa-youtube"></i></a>
            <a href="https://www.instagram.com/aounstore.shop?igsh=OTd4MTRsYjVxeTF2" target="_blank" class="sidebar-social-link instagram"><i class="fab fa-instagram"></i></a>
        </div>
        <div class="sidebar-footer"><button id="logout-btn" class="btn btn-delete" style="width:100%;">Logout</button></div>
      </aside>
      <main class="main-content" id="main-content">
        <div class="mobile-header">
          <img src="logo.gif" alt="SJ10 Logo" class="brand-logo sidebar-logo">
          <button class="menu-toggle" id="menu-toggle">
            <span class="bar"></span><span class="bar"></span><span class="bar"></span>
          </button>
        </div>
        <section id="dashboard" class="page"></section>
        <section id="products" class="page"></section>
        <section id="orders" class="page"></section>
        <section id="promotions" class="page"></section>
        <section id="reviews" class="page"></section>
        <section id="chat" class="page"></section>
        <section id="account" class="page"></section>
        <section id="payment" class="page"></section>
      </main>
    </div>
  </div>

  <div id="product-modal" class="modal-overlay"></div>
  <div id="order-detail-modal" class="modal-overlay"></div>
  <div id="add-payment-modal" class="modal-overlay"></div>
  <div id="variant-modal" class="modal-overlay"></div>
  <div id="review-detail-modal" class="modal-overlay"></div>
  <div id="withdrawal-modal" class="modal-overlay"></div>
  <div id="attributes-modal" class="modal-overlay"></div>
  <div id="promotion-request-modal" class="modal-overlay"></div>
  <div id="payment-info-modal" class="modal-overlay"></div>
  <div id="promotion-detail-modal" class="modal-overlay"></div>
  <div id="dispatch-order-modal" class="modal-overlay"></div>
  
  <div id="loader-overlay" class="modal-overlay" style="flex-direction: column;">
    <div class="loader-spinner"></div>
  </div>

  <div id="confirmation-modal-overlay" class="modal-overlay">
    <div class="confirmation-modal">
        <h3 id="confirmation-title">Are you sure?</h3>
        <p id="confirmation-message">This action cannot be undone.</p>
        <div class="confirmation-buttons">
            <button id="confirm-cancel-btn" class="btn btn-secondary">Cancel</button>
            <button id="confirm-action-btn" class="btn btn-delete">Confirm</button>
        </div>
    </div>
  </div>

  <div id="image-zoom-modal" class="image-zoom-overlay" onclick="closeImageModal()"></div>
  <div id="user-profile-page" class="page-overlay"></div>

  <a href="https://chat.whatsapp.com/HU0KLNwx1BD1ItaKdpSA9y?mode=wwt" target="_blank" class="whatsapp-fab">
    <i class="fab fa-whatsapp"></i>
  </a>

 <script src="attributes.js"></script>
<script defer>
/* ===================================================================================
//
//                              -- START OF CONFIGURATION --
//
// =================================================================================== */

const SUPABASE_URL = 'https://stlaicnoalwlcnjoefjz.supabase.co'; // <-- PASTE YOUR URL HERE
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0bGFpY25vYWx3bGNuam9lZmp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDUxNDEsImV4cCI6MjA3ODM4MTE0MX0.Z4zR5Mefm1k4UsKKJajFLotyOxBDIGbVcsFVQG2uud8'; // <-- PASTE YOUR ANON KEY HERE

// The Track123 API Key has been removed from here for security.
// It should now be stored as a Netlify Environment Variable.

const CLOUDINARY_CLOUD_NAME = 'dusrvdn8a';
const CLOUDINARY_UPLOAD_PRESET = 'supplier_uploads';

let db;
const ADMIN_IDENTIFIER = 'admin';

/* ===================================================================================
//
//                              -- END OF CONFIGURATION --
//
// =================================================================================== */

// Data constants
const signupCategories = ["Fashion Accessories", "Auto Accessories", "Electronics", "Home & Kitchen", "Beauty & Personal Care", "Sports & Outdoors", "Books", "Toys & Games", "Health & Household", "Industrial & Scientific"];
const pakistanCities = ["Abbottabad","Bahawalpur","Faisalabad","Gujranwala","Gujrat","Hyderabad","Islamabad","Karachi","Lahore","Larkana","Mardan","Mirpur","Multan","Muzaffarabad","Peshawar","Quetta","Rahim Yar Khan","Rawalpindi","Sahiwal","Sargodha","Sheikhupura","Sialkot","Sukkur","Wah"].sort();
const ageGroups = ["0-3 Months", "3-6 Months", "6-9 Months", "9-12 Months", "12-18 Months", "18-24 Months", "2-3 Years", "3-4 Years", "4-5 Years", "5-6 Years", "6-7 Years", "7-8 Years", "8-9 Years", "9-10 Years", "10-11 Years", "11-12 Years", "12-13 Years", "13-14 Years", "14-15 Years", "15-16 Years"];
const colorFamilies = [
    { name: 'Red', hex: '#FF0000' }, { name: 'Crimson', hex: '#DC143C' }, { name: 'Firebrick', hex: '#B22222' }, { name: 'Maroon', hex: '#800000' }, { name: 'Dark Red', hex: '#8B0000' }, { name: 'Indian Red', hex: '#CD5C5C' }, { name: 'Tomato', hex: '#FF6347' },
    { name: 'Pink', hex: '#FFC0CB' }, { name: 'Light Pink', hex: '#FFB6C1' }, { name: 'Hot Pink', hex: '#FF69B4' }, { name: 'Deep Pink', hex: '#FF1493' }, { name: 'Fuchsia', hex: '#FF00FF' }, { name: 'Magenta', hex: '#FF00FF' }, { name: 'Rose', hex: '#FF007F' },
    { name: 'Orange', hex: '#FFA500' }, { name: 'Dark Orange', hex: '#FF8C00' }, { name: 'Coral', hex: '#FF7F50' }, { name: 'Orange Red', hex: '#FF4500' }, { name: 'Gold', hex: '#FFD700' }, { name: 'Goldenrod', hex: '#DAA520' },
    { name: 'Yellow', hex: '#FFFF00' }, { name: 'Light Yellow', hex: '#FFFFE0' }, { name: 'Lemon', hex: '#FFFACD' }, { name: 'Khaki', hex: '#F0E68C' }, { name: 'Mustard', hex: '#FFDB58' },
    { name: 'Green', hex: '#008000' }, { name: 'Lime', hex: '#00FF00' }, { name: 'Lime Green', hex: '#32CD32' }, { name: 'Lawn Green', hex: '#7CFC00' }, { name: 'Chartreuse', hex: '#7FFF00' },
    { name: 'Pale Green', hex: '#98FB98' }, { name: 'Mint Green', hex: '#98FF98' }, { name: 'Spring Green', hex: '#00FF7F' }, { name: 'Sea Green', hex: '#2E8B57' }, { name: 'Forest Green', hex: '#228B22' },
    { name: 'Olive', hex: '#808000' }, { name: 'Olive Drab', hex: '#6B8E23' }, { name: 'Dark Green', hex: '#006400' }, { name: 'Teal', hex: '#008080' },
    { name: 'Blue', hex: '#0000FF' }, { name: 'Medium Blue', hex: '#0000CD' }, { name: 'Dark Blue', hex: '#00008B' }, { name: 'Navy', hex: '#000080' }, { name: 'Royal Blue', hex: '#4169E1' },
    { name: 'Dodger Blue', hex: '#1E90FF' }, { name: 'Deep Sky Blue', hex: '#00BFFF' }, { name: 'Sky Blue', hex: '#87CEEB' }, { name: 'Light Blue', hex: '#ADD8E6' }, { name: 'Powder Blue', hex: '#B0E0E6' },
    { name: 'Steel Blue', hex: '#4682B4' }, { name: 'Cadet Blue', hex: '#5F9EA0' }, { name: 'Cornflower Blue', hex: '#6495ED' },
    { name: 'Cyan', hex: '#00FFFF' }, { name: 'Aqua', hex: '#00FFFF' }, { name: 'Light Cyan', hex: '#E0FFFF' }, { name: 'Turquoise', hex: '#40E0D0' }, { name: 'Aquamarine', hex: '#7FFFD4' }, { name: 'Light Sea Green', hex: '#20B2AA' },
    { name: 'Purple', hex: '#800080' }, { name: 'Violet', hex: '#EE82EE' }, { name: 'Orchid', hex: '#DA70D6' }, { name: 'Medium Orchid', hex: '#BA55D3' }, { name: 'Dark Orchid', hex: '#9932CC' },
    { name: 'Indigo', hex: '#4B0082' }, { name: 'Blue Violet', hex: '#8A2BE2' }, { name: 'Dark Violet', hex: '#9400D3' }, { name: 'Lavender', hex: '#E6E6FA' }, { name: 'Plum', hex: '#DDA0DD' },
    { name: 'Brown', hex: '#A52A2A' }, { name: 'Saddle Brown', hex: '#8B4513' }, { name: 'Sienna', hex: '#A0522D' }, { name: 'Chocolate', hex: '#D2691E' }, { name: 'Peru', hex: '#CD853F' },
    { name: 'Tan', hex: '#D2B48C' }, { name: 'Burlywood', hex: '#DEB887' }, { name: 'Beige', hex: '#F5F5DC' }, { name: 'Wheat', hex: '#F5DEB3' }, { name: 'Sandy Brown', hex: '#F4A460' }, { name: 'Terracotta', hex: '#E2725B' },
    { name: 'White', hex: '#FFFFFF' }, { name: 'Snow', hex: '#FFFAFA' }, { name: 'Ivory', hex: '#FFFFF0' }, { name: 'Antique White', hex: '#FAEBD7' }, { name: 'Floral White', hex: '#FFFAF0' }, { name: 'Seashell', hex: '#FFF5EE' },
    { name: 'Gray', hex: '#808080' }, { name: 'Dim Gray', hex: '#696969' }, { name: 'Light Gray', hex: '#D3D3D3' }, { name: 'Slate Gray', hex: '#708090' }, { name: 'Silver', hex: '#C0C0C0' }, { name: 'Charcoal', hex: '#36454F' },
    { name: 'Black', hex: '#000000' },
    { name: 'Gold Metal', hex: '#FFD700' }, { name: 'Silver Metal', hex: '#C0C0C0' }, { name: 'Bronze', hex: '#CD7F32' }, { name: 'Copper', hex: '#B87333' }
].sort((a, b) => a.name.localeCompare(b.name));



// Programmatically add "Custom" and "Package Includes" to all categories
(function enhanceAttributes() {
    const packageIncludesAttr = { name: "Package Includes", type: "Text", options: "e.g., 1 x Shirt, 1 x Trousers" };
    for (const key in categoryAttributes) {
        if (Object.hasOwnProperty.call(categoryAttributes, key)) {
            const attributes = categoryAttributes[key];
            
            if (!attributes.some(attr => attr.name === "Package Includes")) {
                attributes.push(packageIncludesAttr); 
            }

            attributes.forEach(attr => {
                if (attr.type === "Enum" && attr.options && !attr.options.toLowerCase().startsWith("custom")) {
                    attr.options = "Custom, " + attr.options;
                }
            });
        }
    }
})();

/* ---------- END: DYNAMIC ATTRIBUTES DATA V5 ---------- */



/* ---------- STATE & ELEMENTS ---------- */
let state = { 
  categories: [],
  products: [], 
  orders: [], 
  reviews: [],
  messages: [], 
  promotions: [],
  user: null, 
  supplier: null, 
  chatUsers: [], 
  activeChatUser: null, 
  earnings: { totalEarnings: 0, totalWithdrawn: 0, availableBalance: 0 }
};
let newFiles = [];
let realtimeChannel = null;
let newVideoFile = null;
let existingVideoUrl = null;
let newProfilePicFile = null;
let productVariants = [];
let tempSelectedColor = null;
let salesChartInstance = null;
let orderStatusChartInstance = null;
let promotionRequestState = { step: 1, productId: null, productName: null, productImg: null, duration: null, price: null };
let promotionPricingOptions = [];


/* ---------- UI HELPERS ---------- */
const loader = document.getElementById('loader-overlay');
const showLoader = (text = '') => {
    loader.innerHTML = `<div class="loader-spinner"></div>${text ? `<p style="margin-top: 10px; color: var(--text-dark); font-weight: 500; background: var(--white); padding: 5px 10px; border-radius: 8px;">${text}</p>` : ''}`;
    loader.style.display = 'flex';
};
const hideLoader = () => {
    loader.style.display = 'none';
    loader.innerHTML = `<div class="loader-spinner"></div>`;
};


const confirmationModal = document.getElementById('confirmation-modal-overlay');
const confirmTitleEl = document.getElementById('confirmation-title');
const confirmMessageEl = document.getElementById('confirmation-message');
const confirmActionBtn = document.getElementById('confirm-action-btn');
const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

let onConfirmCallback = null;

function showConfirmation(message, callback, title = 'Are you sure?') {
    confirmTitleEl.textContent = title;
    confirmMessageEl.textContent = message;
    onConfirmCallback = callback;
    
    if (callback) {
        confirmActionBtn.style.display = 'inline-flex';
        confirmCancelBtn.textContent = 'Cancel';
    } else {
        confirmActionBtn.style.display = 'none';
        confirmCancelBtn.textContent = 'Close';
    }

    confirmationModal.style.display = 'flex';
    setTimeout(() => confirmationModal.classList.add('visible'), 10);
}

function hideConfirmation() {
    confirmationModal.classList.remove('visible');
    setTimeout(() => {
        confirmationModal.style.display = 'none';
        onConfirmCallback = null;
    }, 250);
}

confirmActionBtn.addEventListener('click', () => {
    if (typeof onConfirmCallback === 'function') {
        onConfirmCallback();
    }
    hideConfirmation();
});
confirmCancelBtn.addEventListener('click', hideConfirmation);
confirmationModal.addEventListener('click', (e) => {
    if (e.target === confirmationModal) {
        hideConfirmation();
    }
});


/* ---------- AUTHENTICATION & INITIALIZATION ---------- */
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    
  db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const { data: { session } } = await db.auth.getSession();
  
  if (session) {
    await handleExistingSession(session.user);
  } else {
    showAuthPage();
  }
  
  setupEventListeners();
  setupDraggableWhatsAppButton();
  loadCities();
  loadSignupCategories();
  loadAgeGroups();
}

async function fetchInitialData() {
    showLoader();
    try {
        const { data: categoriesData, error: categoriesError } = await db.from('categories').select('*');
        if (categoriesError) {
            console.error("Error fetching categories:", categoriesError);
        } else {
            state.categories = categoriesData || [];
        }
        await checkAllNotifications();
    } finally {
        hideLoader();
    }
}

function setupEventListeners() {
  document.getElementById('login-form').addEventListener('submit', handleLogin);
  document.getElementById('signup-form').addEventListener('submit', handleSignup);
  document.getElementById('show-signup-btn').addEventListener('click', () => toggleAuthForms('signup'));
  document.getElementById('show-login-btn').addEventListener('click', () => toggleAuthForms('login'));
  document.getElementById('logout-btn').addEventListener('click', handleLogout);
  
  document.getElementById('menu-toggle').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('is-open');
  });
  
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', handleNavigation);
  });
}

function toggleAuthForms(form) {
  document.getElementById('login-form').style.display = form === 'login' ? 'block' : 'none';
  document.getElementById('signup-form').style.display = form === 'signup' ? 'block' : 'none';
  document.getElementById('success-message-container').style.display = 'none';
}

function showAuthPage() {
  document.body.classList.remove('app-visible');
  document.getElementById('auth-page').style.display = 'flex';
  document.getElementById('app-wrapper').style.display = 'none';
}

async function isUserApproved(user) {
    if (!user) return false;
    try {
        const { data: supplier, error } = await db.from('suppliers').select('status').eq('id', user.id).single();
        if (error || !supplier) return false;
        return supplier.status === 'approved';
    } catch (e) {
        return false;
    }
}

async function handleExistingSession(user) {
  state.user = user;
  const approved = await isUserApproved(user);

  if (approved) {
    await loadSupplierData();
    await fetchInitialData();
    showApp();
  } else {
    await db.auth.signOut();
    showAuthPage();
    const errorDiv = document.getElementById('login-error');
    errorDiv.textContent = 'Your account must be approved by an administrator.';
    errorDiv.style.display = 'block';
  }
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const errorDiv = document.getElementById('login-error');
  showLoader();
  try {
    const { data, error } = await db.auth.signInWithPassword({ email, password });
    if (error) throw error;
    
    const approved = await isUserApproved(data.user);
    if (!approved) {
        await db.auth.signOut();
        throw new Error('Your account is not approved or has been suspended.');
    }

    state.user = data.user;
    await loadSupplierData();
    await fetchInitialData();
    showApp();
    
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.style.display = 'block';
  } finally {
      hideLoader();
  }
}

async function handleSignup(e) {
    e.preventDefault();
    const signupBtn = e.target.querySelector('button[type="submit"]');
    const originalBtnHTML = signupBtn.innerHTML;
    const errorDiv = document.getElementById('signup-error');
    errorDiv.style.display = 'none';

    // --- Get all form values ---
    const email = document.getElementById('signup-email').value.toLowerCase();
    const password = document.getElementById('signup-password').value;
    const fullName = document.getElementById('signup-fullname').value;
    const brandName = document.getElementById('signup-brand-name').value;
    const contactNumber = document.getElementById('signup-contact').value;
    const age = document.getElementById('signup-age').value;
    const city = document.getElementById('signup-city').value;
    const address = document.getElementById('signup-address').value;
    const street_no = document.getElementById('signup-street-no').value;
    const business_type = document.getElementById('business-type').value;
    const stock_quantity_range = document.getElementById('stock-quantity').value;
    const business_gender = document.getElementById('business-gender').value;
    const selected_categories = Array.from(document.querySelectorAll('#signup-category-checkboxes input:checked')).map(cb => cb.value);

    const profilePicFile = document.getElementById('signup-profile-pic-file').files[0];
    if (!profilePicFile) {
        errorDiv.textContent = 'Profile Picture is required.';
        errorDiv.style.display = 'block';
        return;
    }

    signupBtn.disabled = true;
    signupBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`;
    showLoader('Creating your account...');

    try {
        // --- Step 1: Upload the profile picture to Cloudinary FIRST ---
        showLoader('Uploading profile picture...');
        const profilePicUrl = await uploadToCloudinary(profilePicFile, 'profile_pictures');
        if (!profilePicUrl) {
            throw new Error("Failed to upload profile picture. Please try again.");
        }

        // --- Step 2: Sign up the user with email, password, and ALL other data in the `options.data` field ---
        showLoader('Finalizing account...');
        const { data, error: signUpError } = await db.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    // This data will be automatically copied to your suppliers table by the trigger
                    full_name: fullName,
                    brand_name: brandName,
                    contact_number: contactNumber,
                    profile_pic: profilePicUrl,
                    age: age,
                    city: city,
                    address: address,
                    street_no: street_no,
                    business_type: business_type,
                    stock_quantity_range: stock_quantity_range,
                    business_gender: business_gender,
                    selected_categories: selected_categories
                }
            }
        });

        if (signUpError) throw signUpError;
        
        // --- Success ---
        document.getElementById('signup-form').style.display = 'none';
        const successMessageHTML = `<h3>Verification Email Sent!</h3><p>Please check your inbox at <strong>${email}</strong> to verify your email address. Once verified, an administrator will review and approve your account.</p>`;
        document.getElementById('success-message-content').innerHTML = successMessageHTML;
        document.getElementById('success-message-container').style.display = 'block';

    } catch (error) {
        errorDiv.textContent = 'Error: ' + error.message;
        errorDiv.style.display = 'block';
    } finally {
        signupBtn.disabled = false;
        signupBtn.innerHTML = originalBtnHTML;
        hideLoader();
    }
}


async function handleLogout() {
  if(realtimeChannel) {
    db.removeChannel(realtimeChannel);
    realtimeChannel = null;
  }
  await db.auth.signOut();
  state = { categories: [], products: [], orders: [], reviews: [], messages: [], promotions: [], user: null, supplier: null, chatUsers: [], activeChatUser: null };
  
  document.getElementById('app-wrapper').style.opacity = '0';
  setTimeout(() => {
    document.getElementById('app-wrapper').style.display = 'none';
    showAuthPage();
    toggleAuthForms('login');
  }, 500);
}

/* ---------- SUPPLIER DATA ---------- */
async function loadSupplierData() {
    if (!state.user) return;
    try {
        const { data, error } = await db.from('suppliers').select('*').eq('id', state.user.id).single();
        if (error) { 
            throw new Error(`Could not load supplier profile: ${error.message}`);
        }
        state.supplier = data;
    } catch (error) {
        console.error('Error loading supplier data:', error);
        await handleLogout();
    }
}


/* ---------- CITIES & CATEGORIES ---------- */
function loadCities() {
  const citySelect = document.getElementById('signup-city');
  if (!citySelect) return;
  citySelect.innerHTML = '<option value="">Select City...</option>';
  pakistanCities.forEach(city => {
    const option = document.createElement('option');
    option.value = city;
    option.textContent = city;
    citySelect.appendChild(option);
  });
}

function loadAgeGroups() {
    const ageSelect = document.getElementById('signup-age');
    if (!ageSelect) return;
    ageSelect.innerHTML = '<option value="">Select Age Group...</option>';
    ageGroups.forEach(age => {
        const option = document.createElement('option');
        option.value = age;
        option.textContent = age;
        ageSelect.appendChild(option);
    });
}

function loadSignupCategories() {
  const signupCategoryCheckboxes = document.getElementById('signup-category-checkboxes');
  if (!signupCategoryCheckboxes) return;
  signupCategoryCheckboxes.innerHTML = '';
  signupCategories.forEach(category => {
    const div = document.createElement('div');
    div.className = 'category-checkbox-item';
    div.innerHTML = `
        <input type="checkbox" id="cat-${category.replace(/\s+/g, '-').toLowerCase()}" value="${category}" name="categories">
        <label for="cat-${category.replace(/\s+/g, '-').toLowerCase()}">${category}</label>
    `;
    signupCategoryCheckboxes.appendChild(div);
  });
}

/* ---------- APP INITIALIZATION ---------- */
function showApp() {
  document.body.classList.add('app-visible');
  document.getElementById('auth-page').style.display = 'none';
  document.getElementById('app-wrapper').style.display = 'block';
  setTimeout(() => {
    document.getElementById('app-wrapper').style.opacity = '1';
  }, 50);
  
  requestNotificationPermission();
  handleNavigation({ preventDefault: () => {}, target: document.querySelector('.nav-link[href="#dashboard"]') });
  setupRealtimeSubscription();
}


/* ---------- NAVIGATION ---------- */
function handleNavigation(e) {
  e.preventDefault();
  const targetId = e.target.getAttribute('href').substring(1);
  
  document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
  e.target.classList.add('active');
  
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  document.getElementById(targetId).classList.add('active');
  
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar').classList.remove('is-open');
  }
  
  switch(targetId) {
    case 'dashboard': loadDashboard(); break;
    case 'products': loadProducts(); break;
    case 'orders': 
        loadOrders().then(() => {
            const latestOrder = state.orders[0];
            if(latestOrder) localStorage.setItem('lastSeenOrderId', latestOrder.id);
            checkAllNotifications();
        });
        break;
    case 'promotions': loadPromotions(); break;
    case 'reviews': loadReviews(); break;
    case 'chat': 
        loadChat().then(() => checkAllNotifications());
        break;
    case 'account': loadAccount(); break;
    case 'payment': loadPayment(); break;
  }
}

/* ---------- DASHBOARD ---------- */
async function loadDashboard() {
  const dashboardPage = document.getElementById('dashboard');
  if (!state.supplier) return;
  showLoader();
  try {
    const { count: totalProducts, error: productsError } = await db.from('products').select('id', { count: 'exact' }).eq('supplier_id', state.supplier.id);
    if(productsError) throw productsError;

    const { data: ordersData, error: ordersError } = await db.rpc('get_orders_for_supplier', { p_supplier_id: state.supplier.id });
    if(ordersError) throw ordersError;
    state.orders = ordersData || [];

    const totalOrders = state.orders.length;
    const pendingOrders = state.orders.filter(o => o.status === 'Processing').length; // Changed from pending to processing as per user's audio
    const totalSales = state.orders.reduce((sum, order) => sum + (order.total_price || 0), 0);
    
    dashboardPage.innerHTML = `
      <div class="page-header"><h1 class="main-header">Dashboard</h1></div>
      <div class="dashboard-social-icons">
        <a href="https://www.facebook.com/share/1A6fShxiZf/" target="_blank" class="social-icon-link social-icon-facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="https://www.youtube.com/@Brandyt120" target="_blank" class="social-icon-link social-icon-youtube"><i class="fab fa-youtube"></i></a>
        <a href="https://www.instagram.com/aounstore.shop?igsh=OTd4MTRsYjVxeTF2" target="_blank" class="social-icon-link social-icon-instagram"><i class="fab fa-instagram"></i></a>
      </div>
      <div class="dashboard-cards-container">
        <div class="card" id="dash-products"><h3 >Total Products</h3><p style="color: var(--primary-color);">${totalProducts || 0}</p></div>
        <div class="card" id="dash-orders"><h3>Total Orders</h3><p style="color: var(--info);">${totalOrders}</p></div>
        <div class="card" id="dash-pending"><h3>New Orders</h3><p style="color: var(--warning);">${pendingOrders}</p></div>
        <div class="card" id="dash-sales"><h3>Total Sales</h3><p style="color: var(--success);">PKR ${totalSales.toLocaleString()}</p></div>
      </div>
      <div class="dashboard-charts-container">
          <div class="card"><canvas id="salesChart"></canvas></div>
          <div class="card"><canvas id="orderStatusChart"></canvas></div>
      </div>
      <div class="card" style="animation: card-fade-in 0.5s 0.5s ease-out forwards; opacity: 0;">
        <h3>Welcome, ${state.supplier.brand_name}!</h3>
        <p>Manage your products, view orders, and communicate with customers.</p>
        ${(totalProducts || 0) === 0 ? `<div style="text-align: center; padding: 20px; border: 2px dashed var(--border-color); border-radius: 8px; margin-top: 20px;"><h4>Get Started</h4><p>Add your first product to start selling!</p><button class="btn btn-primary" onclick="showAddProductForm()">Add Your First Product</button></div>` : ''}
      </div>`;
    
    renderDashboardCharts(state.orders);

  } catch (error) {
    console.error('Error loading dashboard:', error);
    dashboardPage.innerHTML = `<div class="error-message">Error loading dashboard data: ${error.message}</div>`;
  } finally {
    hideLoader();
  }
}

function renderDashboardCharts(orders) {
    const salesCtx = document.getElementById('salesChart')?.getContext('2d');
    const statusCtx = document.getElementById('orderStatusChart')?.getContext('2d');
    if (!salesCtx || !statusCtx) return;

    if (salesChartInstance) salesChartInstance.destroy();
    if (orderStatusChartInstance) orderStatusChartInstance.destroy();

    const salesData = {};
    const today = new Date();
    const labels = [];
    for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const formattedDate = date.toISOString().split('T')[0];
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        salesData[formattedDate] = 0;
    }

    orders.forEach(order => {
        const orderDate = new Date(order.created_at).toISOString().split('T')[0];
        if (salesData.hasOwnProperty(orderDate)) {
            salesData[orderDate] += order.total_price;
        }
    });
    
    const gradient = salesCtx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(79, 70, 229, 0.4)');
    gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

    salesChartInstance = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Sales (PKR)',
                data: Object.values(salesData),
                borderColor: 'rgba(79, 70, 229, 1)',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                pointBorderColor: '#fff',
                pointHoverRadius: 7,
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(79, 70, 229, 1)'
            }]
        },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: 'Sales Over Last 30 Days' } }
        }
    });

    const statusCounts = orders.reduce((acc, order) => {
        const status = order.status.charAt(0).toUpperCase() + order.status.slice(1);
        acc[status] = (acc[status] || 0) + 1;
        return acc;
    }, {});
    
    orderStatusChartInstance = new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(statusCounts),
            datasets: [{
                label: 'Order Status',
                data: Object.values(statusCounts),
                backgroundColor: [
                    'rgba(249, 115, 22, 0.8)',
                    'rgba(22, 163, 74, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(107, 114, 128, 0.8)'
                ],
                borderColor: '#fff',
                borderWidth: 2,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: 'Order Status Distribution' } }
        }
    });
}


/* ---------- PRODUCTS MANAGEMENT ---------- */
async function loadProducts() {
  const productsPage = document.getElementById('products');
  if (!state.supplier) return;
  showLoader();
  try {
    const { data: products, error } = await db.from('products').select('*').eq('supplier_id', state.supplier.id).order('created_at', { ascending: false });
    if (error) throw error;
    state.products = products || [];
    
    productsPage.innerHTML = `
      <div class="page-header"><h1 class="main-header">My Products</h1><button class="btn btn-primary" onclick="showAddProductForm()">Add Product</button></div>
      <div class="card">
        ${state.products.length > 0 ? `
          <table class="content-table">
            <thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Stock</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
              ${state.products.map(product => `
                <tr data-product-id="${product.id}">
                  <td data-label="Image"><img src="${product.image_url || 'https://via.placeholder.com/64'}" alt="${product.title}" class="product-thumbnail" loading="lazy"></td>
                  <td data-label="Name">${product.title}</td>
                  <td data-label="Price">PKR ${product.price}</td>
                  <td data-label="Stock">${product.quantity}</td>
                  <td data-label="Status">${product.status === 'in_stock' ? 'In Stock' : 'Out of Stock'}</td>
                  <td data-label="Actions">
                    <button class="btn btn-edit" onclick="editProduct('${product.id}')">Edit</button>
                    <button class="btn btn-delete" onclick="deleteProduct('${product.id}')">Delete</button>
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>` : `<div style="text-align: center; padding: 40px;"><h3>No Products Yet</h3><p>Add your first product to showcase in your store.</p><button class="btn btn-primary" onclick="showAddProductForm()">Add Your First Product</button></div>`}
      </div>`;
  } catch (error) {
    console.error('Error loading products:', error);
    productsPage.innerHTML = `<div class="error-message">Error loading products: ${error.message}</div>`;
  } finally {
      hideLoader();
  }
}

function showAddProductForm(product = null) {
  const isEdit = !!product;
  newFiles = [];
  newVideoFile = null;
  existingVideoUrl = isEdit ? product?.video_url : null;
  productVariants = [];

  const modalContent = `
    <div class="modal">
      <h2>${isEdit ? 'Edit Product' : 'Add New Product'}</h2>
      <form id="product-form">
        <input type="hidden" id="product-id" value="${product?.id || ''}">
        <input type="hidden" id="product-attributes-data" value='${isEdit && product.attributes ? JSON.stringify(product.attributes) : "{}"}'>

        <div class="form-grid">
          <div class="form-group full-width"><label for="product-title">Product Title</label><input type="text" id="product-title" value="${product?.title || ''}" required></div>
          <div class="form-group full-width"><label for="product-description">Description</label><textarea id="product-description" rows="5" placeholder="Provide a detailed and attractive description for your product...">${product?.description || ''}</textarea></div>
          
          <div class="form-group"><label for="product-base-price">Base Price (PKR)</label><input type="number" id="product-base-price" step="0.01" value="${product?.price || ''}" required></div>
          <div class="form-group"><label for="product-base-discounted-price">Base Discounted Price (PKR)</label><input type="number" id="product-base-discounted-price" step="0.01" value="${product?.discounted_price || ''}"></div>
          <div class="form-group"><label for="product-base-quantity">Base Stock Quantity</label><input type="number" id="product-base-quantity" value="${product?.quantity || ''}" required></div>
          <div class="form-group"><label for="product-status">Status</label><select id="product-status"><option value="in_stock" ${product?.status === 'in_stock' ? 'selected' : ''}>In Stock</option><option value="out_of_stock" ${product?.status === 'out_of_stock' ? 'selected' : ''}>Out of Stock</option></select></div>
          
          <div class="form-group full-width"><label for="product-parent-category">Main Category</label><select id="product-parent-category" required></select></div>
          <div class="form-group full-width" id="sub-category-container" style="display:none;"><label>Sub-Category (select one)</label><div id="product-sub-category-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px;"></div></div>
          
          <div class="form-group full-width"><label for="product-season">Season</label>
            <select id="product-season">
              <option value="NULL">No Season</option>
              <option value="Custom">Custom Season</option>
              <option value="All Seasons">All Seasons</option>
              <option value="Summer">Summer</option>
              <option value="Winter">Winter</option>
              <option value="Spring">Spring</option>
              <option value="Autumn">Autumn</option>
            </select>
            <input type="text" id="product-season-custom" style="display:none; margin-top: 10px;" placeholder="Enter custom season">
          </div>
          
          <div id="attributes-section">
            <button type="button" class="btn btn-secondary" id="attributes-btn" onclick="openAttributesManager()" disabled><i class="fas fa-list-alt"></i> Add Product Attributes</button>
            <span id="attributes-status">Select a sub-category first</span>
          </div>

          <div class="form-group full-width"><label>Product Variants</label><p style="font-size: 0.9em; color: var(--text-light); margin-top: -5px;">Add different versions of your product, like colors and sizes.</p><button type="button" class="btn btn-primary" onclick="openVariantManager()"><i class="fas fa-sitemap"></i> Manage Variants</button><div id="variant-display-area" style="margin-top: 15px; font-style: italic; color: var(--text-light);">No variants added.</div></div>

          <div class="form-group full-width" style="border-top: 2px solid var(--border-color); padding-top: 15px;"><label>Shipping & Packaging</label></div>
          <div class="form-group"><label for="shipping-details">Shipping Method</label><select id="shipping-details"><option value="Standard">Standard</option><option value="Express">Express</option><option value="Overnight">Overnight</option></select></div>
          <div class="form-group"><label>Package Dimensions</label><div style="display:flex; gap: 8px; align-items: center;"><input type="number" id="pkg-length" placeholder="L"><input type="number" id="pkg-width" placeholder="W"><input type="number" id="pkg-height" placeholder="H"><select id="pkg-unit"><option value="cm">cm</option><option value="in">in</option></select></div></div>
          <div class="form-group"><label>Package Weight</label><div style="display:flex; gap: 8px; align-items: center;"><input type="number" id="pkg-weight" placeholder="e.g., 500"><select id="pkg-weight-unit"><option value="g">g</option><option value="kg">kg</option><option value="mg">mg</option></select></div></div>
          
          <div class="form-group full-width" style="border-top: 2px solid var(--border-color); padding-top: 15px;"><label>Product Images (Max 8)</label><label for="product-images" class="btn btn-secondary"><i class="fas fa-upload"></i> Upload Images</label><input type="file" id="product-images" style="display:none;" multiple accept="image/*" onchange="handleImageUpload(event)"><div id="image-previews"></div></div>
          
          <div class="form-group full-width"><label>Product Video</label><label for="product-video-file" class="btn btn-secondary" style="display: inline-block; cursor: pointer;"><i class="fas fa-video"></i> Choose Video</label><input type="file" id="product-video-file" accept="video/mp4,video/mov" style="display: none;" onchange="handleVideoUpload(event)"><div id="video-upload-progress" style="display: none; margin-top: 10px;"><p>Uploading...</p><progress id="video-progress-bar" value="0" max="100" style="width: 100%;"></progress></div><div id="video-preview-container" style="margin-top: 15px; position: relative; max-width: 300px;"></div></div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal('product-modal')">Cancel</button>
          <button type="submit" id="submit-product-btn" class="btn btn-primary">${isEdit ? 'Update' : 'Save'} Product</button>
        </div>
      </form>
    </div>
  `;
  
  const modalOverlay = document.getElementById('product-modal');
  modalOverlay.innerHTML = modalContent;
  modalOverlay.style.display = 'flex';
  setTimeout(() => modalOverlay.classList.add('visible'), 10);

  document.getElementById('product-form').addEventListener('submit', handleProductSubmit);
  
  const parentCategorySelect = document.getElementById('product-parent-category');
  const subCategoryContainer = document.getElementById('sub-category-container');
  const subCategoryCheckboxes = document.getElementById('product-sub-category-checkboxes');
  const attributesBtn = document.getElementById('attributes-btn');
  const attributesStatus = document.getElementById('attributes-status');
  const seasonSelect = document.getElementById('product-season');
  const seasonCustomInput = document.getElementById('product-season-custom');

  seasonSelect.addEventListener('change', () => {
      seasonCustomInput.style.display = seasonSelect.value === 'Custom' ? 'block' : 'none';
  });
  
  const parentCategories = state.categories.filter(c => c.parent_id === null);
  parentCategorySelect.innerHTML = '<option value="">Select a main category...</option>' + parentCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

  parentCategorySelect.onchange = () => {
      const selectedParentId = parentCategorySelect.value;
      attributesBtn.disabled = true;
      attributesStatus.textContent = 'Select a sub-category first';
      document.getElementById('product-attributes-data').value = '{}';

      if (selectedParentId) {
          const subCategories = state.categories.filter(c => c.parent_id == selectedParentId);
          if (subCategories.length > 0) {
              subCategoryCheckboxes.innerHTML = subCategories.map(c => `
                  <div class="category-checkbox-item" style="display:flex; align-items:center;">
                      <input type="radio" id="cat-${c.id}" value="${c.id}" name="product-subcategory" style="width: auto; margin-right: 8px;">
                      <label for="cat-${c.id}">${c.name}</label>
                  </div>`).join('');
              subCategoryContainer.style.display = 'block';
          } else {
              subCategoryContainer.style.display = 'none';
              subCategoryCheckboxes.innerHTML = '';
          }
      } else {
          subCategoryContainer.style.display = 'none';
          subCategoryCheckboxes.innerHTML = '';
      }
  };
  
  subCategoryCheckboxes.addEventListener('change', (e) => {
      if (e.target.name === 'product-subcategory') {
          attributesBtn.disabled = false;
          attributesStatus.textContent = 'Click to add attributes';
          document.getElementById('product-attributes-data').value = '{}';
      }
  });

  if (isEdit) {
    if (product.category_id) {
        const subCategory = state.categories.find(c => c.id === product.category_id);
        if (subCategory && subCategory.parent_id) {
            parentCategorySelect.value = subCategory.parent_id;
            parentCategorySelect.dispatchEvent(new Event('change'));
            setTimeout(() => {
                const radio = document.querySelector(`input[name="product-subcategory"][value="${product.category_id}"]`);
                if (radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change', { bubbles: true }));
                    const savedAttrCount = Object.keys(product.attributes || {}).length;
                    attributesStatus.textContent = `${savedAttrCount} attributes added`;
                }
            }, 100);
        }
    }
    if (product.season) {
        if (['All Seasons', 'Summer', 'Winter', 'Spring', 'Autumn'].includes(product.season)) {
            seasonSelect.value = product.season;
        } else {
            seasonSelect.value = 'Custom';
            seasonCustomInput.value = product.season;
            seasonCustomInput.style.display = 'block';
        }
    } else {
        seasonSelect.value = 'NULL';
    }

    if (product.image_urls && product.image_urls.length > 0) {
      document.getElementById('image-previews').innerHTML = product.image_urls.map(url => `
        <div class="preview-image-container" data-url="${url}">
          <img src="${url}" class="preview-image">
          <button type="button" class="delete-preview-btn" onclick="removeExistingImage(this)">√ó</button>
        </div>`).join('');
    }
    if (product.video_url) {
        document.getElementById('video-preview-container').innerHTML = `<video src="${product.video_url}" controls style="width: 100%; border-radius: 8px;"></video><button type="button" class="delete-preview-btn" onclick="removeVideoPreview()" style="top: 5px; right: 5px;">√ó</button>`;
    }
    if (product.package_information) {
        const [dims, weight] = product.package_information.split(', ');
        if (dims) {
            const dimParts = dims.match(/(\d+)x(\d+)x(\d+)\s(cm|in)/);
            if(dimParts) {
                document.getElementById('pkg-length').value = dimParts[1];
                document.getElementById('pkg-width').value = dimParts[2];
                document.getElementById('pkg-height').value = dimParts[3];
                document.getElementById('pkg-unit').value = dimParts[4];
            }
        }
        if (weight) {
            const weightParts = weight.match(/(\d+)(g|kg|mg)/);
            if(weightParts) {
                document.getElementById('pkg-weight').value = weightParts[1];
                document.getElementById('pkg-weight-unit').value = weightParts[2];
            }
        }
    }
    fetchAndLoadVariants(product.id);
  }
}


/* ---------- START: DYNAMIC ATTRIBUTE FUNCTIONS ---------- */
function openAttributesManager() {
    const subcategoryRadio = document.querySelector('input[name="product-subcategory"]:checked');
    if (!subcategoryRadio) {
        showConfirmation("Please select a sub-category before adding attributes.", null, "Selection Required");
        return;
    }
    const subcategoryId = subcategoryRadio.value;
    const subCategory = state.categories.find(c => c.id == subcategoryId);
// CORRECT - This is the new, correct way
const attributesKey = subcategoryId;
    const attributes = categoryAttributes[attributesKey];
    
    if (!attributes || attributes.length === 0) {
        showConfirmation("No specific attributes are defined for this sub-category. You can add your own custom attributes.", null, "Information", true);
    }

    let fieldsHtml = `<h3>Product Specifications for ${subCategory.name}</h3><div class="attributes-grid">`;
    (attributes || []).forEach((attr, index) => {
        const fieldId = `attr-modal-${attr.name.replace(/[^a-zA-Z0-9]/g, '-')}`;
        let field = '';

        const commonProps = `id="${fieldId}" data-attr-name="${attr.name}" onchange="handleAttributeChange(this)"`;

        switch(attr.type.toLowerCase()) {
            case 'enum':
                const options = attr.options.split(',').map(o => o.trim());
                field = `<select ${commonProps}>
                            ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                         </select>
                         <input type="text" data-custom-for="${fieldId}" style="display:none; margin-top: 10px;" placeholder="Enter custom value" maxlength="50">`;
                break;
            case 'number':
                field = `<input type="number" ${commonProps} placeholder="${attr.options || ''}">`;
                break;
             case 'measurement':
                field = `<div class="measurement-group">
                            <input type="number" ${commonProps}>
                            <select id="${fieldId}-unit" data-unit-for="${attr.name}">
                                ${attr.units.map(u => `<option value="${u}">${u}</option>`).join('')}
                            </select>
                         </div>`;
                break;
            case 'textarea':
                field = `<textarea rows="4" ${commonProps} placeholder="${attr.options || ''}"></textarea>`;
                break;
            case 'text':
            default:
                field = `<input type="text" ${commonProps} placeholder="${attr.options || ''}">`;
                break;
        }
        fieldsHtml += `<div class="form-group" style="animation-delay: ${index * 50}ms">
                        <label for="${fieldId}">${attr.name}</label>
                        ${field}
                       </div>`;
    });
    fieldsHtml += '</div>';
    
    fieldsHtml += `<div style="grid-column: 1 / -1; border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 20px;">
        <h4>Custom Attributes</h4>
        <div id="custom-attributes-container"></div>
        <button type="button" class="btn btn-secondary" onclick="addCustomAttributePair()"><i class="fas fa-plus"></i> Add Custom Attribute</button>
    </div>`;

    const modal = document.getElementById('attributes-modal');
    modal.innerHTML = `
        <div class="modal">
            <div id="attributes-modal-content">${fieldsHtml}</div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('attributes-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAttributesFromModal()">Save Attributes</button>
            </div>
        </div>
    `;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
    
    const existingAttributesData = document.getElementById('product-attributes-data').value;
    if (existingAttributesData) {
        try {
            const savedAttributes = JSON.parse(existingAttributesData);
            for (const key in savedAttributes) {
                const fieldId = `attr-modal-${key.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const field = document.getElementById(fieldId);
                const attrDef = attributes?.find(a => a.name === key);

                if (field && attrDef) { // It's a predefined attribute
                    if (attrDef.type.toLowerCase() === 'measurement') {
                        const [value, unit] = savedAttributes[key].split(' ');
                        field.value = value;
                        const unitField = document.getElementById(`${fieldId}-unit`);
                        if (unitField) unitField.value = unit;
                    } else if (attrDef.type.toLowerCase() === 'enum') {
                        const isCustom = ![...field.options].some(opt => opt.value === savedAttributes[key]);
                        if (isCustom) {
                            field.value = 'Custom';
                            const customInput = document.querySelector(`[data-custom-for="${fieldId}"]`);
                            customInput.value = savedAttributes[key];
                            customInput.style.display = 'block';
                        } else {
                            field.value = savedAttributes[key];
                        }
                    } else {
                        field.value = savedAttributes[key];
                    }
                } else { // It's a custom key-value attribute
                    addCustomAttributePair(key, savedAttributes[key]);
                }
            }
        } catch (e) { console.error("Could not parse existing attributes:", e); }
    }
}

function handleAttributeChange(element) {
    if (element.tagName === 'SELECT' && element.dataset.attrName) {
        const customInput = document.querySelector(`[data-custom-for="${element.id}"]`);
        if (customInput) {
            customInput.style.display = element.value === 'Custom' ? 'block' : 'none';
        }
    }
}


function addCustomAttributePair(key = '', value = '') {
    const container = document.getElementById('custom-attributes-container');
    const div = document.createElement('div');
    div.className = 'custom-attribute-pair';
    div.innerHTML = `
        <input type="text" class="custom-attr-key" placeholder="Label (e.g., Special Feature)" value="${key}">
        <input type="text" class="custom-attr-value" placeholder="Value (e.g., Water Resistant)" value="${value}">
        <button type="button" class="btn btn-delete" onclick="this.parentElement.remove()" style="padding: 5px 10px;"><i class="fas fa-trash"></i></button>
    `;
    container.appendChild(div);
}

function saveAttributesFromModal() {
    const attributes = {};
    let attrCount = 0;
    
    document.querySelectorAll('#attributes-modal [data-attr-name]').forEach(field => {
        const attrName = field.dataset.attrName;
        let value = field.value;

        if (field.tagName === 'SELECT' && value === 'Custom') {
            const customInput = document.querySelector(`[data-custom-for="${field.id}"]`);
            value = customInput ? customInput.value : '';
        }
        
        const subcategoryRadio = document.querySelector('input[name="product-subcategory"]:checked');
        if (!subcategoryRadio) return; // Should not happen but as a safeguard
        const subCategoryName = subcategoryRadio.labels[0].textContent.trim().toLowerCase().replace(/&/g, 'and').replace(/\s+/g, ' ');
        const attrDef = categoryAttributes[subCategoryName]?.find(a => a.name === attrName);

        if (attrDef && attrDef.type.toLowerCase() === 'measurement' && value) {
            const unitField = document.getElementById(`${field.id}-unit`);
            value = `${value} ${unitField.value}`;
        }
        
        if (value && value.trim() !== '') {
            attributes[attrName] = value.trim();
            attrCount++;
        }
    });

    document.querySelectorAll('.custom-attribute-pair').forEach(pair => {
        const key = pair.querySelector('.custom-attr-key').value.trim();
        const value = pair.querySelector('.custom-attr-value').value.trim();
        if (key && value) {
            attributes[key] = value;
            attrCount++;
        }
    });

    if (attrCount < 2) {
        showConfirmation("Please fill in at least two attributes before saving.", null, "More Information Needed");
        return;
    }

    document.getElementById('product-attributes-data').value = JSON.stringify(attributes);
    document.getElementById('attributes-status').textContent = `${attrCount} attribute(s) added.`;
    closeModal('attributes-modal');
}
/* ---------- END: DYNAMIC ATTRIBUTE FUNCTIONS ---------- */


async function handleProductSubmit(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submit-product-btn');
    const originalBtnHTML = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`;
    showLoader();
    try {
        const productId = document.getElementById('product-id').value;
        const isEdit = !!productId;

        const attributesData = document.getElementById('product-attributes-data').value;
        const attributes = attributesData ? JSON.parse(attributesData) : {};
        if (Object.keys(attributes).length < 2) {
            throw new Error("You must add at least two product attributes before saving.");
        }

        const selectedSubCategory = document.querySelector('#product-sub-category-checkboxes input:checked');
        const selectedCategoryId = selectedSubCategory ? parseInt(selectedSubCategory.value) : null;

        const activeNewFiles = newFiles.filter(f => f);
        const uploadedUrls = await Promise.all(activeNewFiles.map(file => uploadToCloudinary(file)));
        let finalVideoUrl = existingVideoUrl; 
        if (newVideoFile) {
            finalVideoUrl = await uploadVideoToCloudinary(newVideoFile);
        }
        let existingImageUrls = [];
        if (isEdit) {
            document.querySelectorAll('#image-previews .preview-image-container').forEach(el => {
                if (el.dataset.url && !el.dataset.removed) existingImageUrls.push(el.dataset.url);
            });
        }
        const allImageUrls = [...existingImageUrls, ...uploadedUrls.filter(url => url !== null)];
        
        const pkgL = document.getElementById('pkg-length').value;
        const pkgW = document.getElementById('pkg-width').value;
        const pkgH = document.getElementById('pkg-height').value;
        const pkgUnit = document.getElementById('pkg-unit').value;
        const pkgWeight = document.getElementById('pkg-weight').value;
        const pkgWeightUnit = document.getElementById('pkg-weight-unit').value;
        
        let dimsPart = '';
        let weightPart = '';
        if (pkgL && pkgW && pkgH) {
            dimsPart = `${pkgL}x${pkgW}x${pkgH} ${pkgUnit}`;
        }
        if (pkgWeight) {
            weightPart = `${pkgWeight}${pkgWeightUnit}`;
        }
        const packageInfo = [dimsPart, weightPart].filter(Boolean).join(', ');

        const seasonSelect = document.getElementById('product-season');
        let seasonValue = seasonSelect.value;
        if (seasonValue === 'Custom') {
            seasonValue = document.getElementById('product-season-custom').value.trim();
        } else if (seasonValue === 'NULL') {
            seasonValue = null;
        }

        const productData = {
            title: document.getElementById('product-title').value,
            description: document.getElementById('product-description').value,
            price: parseFloat(document.getElementById('product-base-price').value),
            discounted_price: document.getElementById('product-base-discounted-price').value ? parseFloat(document.getElementById('product-base-discounted-price').value) : null,
            quantity: parseInt(document.getElementById('product-base-quantity').value),
            status: document.getElementById('product-status').value,
            video_url: finalVideoUrl,
            image_urls: allImageUrls,
            image_url: allImageUrls[0] || null,
            supplier_id: state.supplier.id,
            category_id: selectedCategoryId,
            shipping_details: document.getElementById('shipping-details').value,
            package_information: packageInfo || null,
            attributes: attributes,
            season: seasonValue
        };
        
        const { data: productResult, error: productError } = isEdit
            ? await db.from('products').update(productData).eq('id', productId).select().single()
            : await db.from('products').insert(productData).select().single();
        if (productError) throw productError;
        const savedProductId = productResult.id;

        if (isEdit) {
            await db.from('variants').delete().eq('product_id', savedProductId);
        }
        
        if (productVariants.length > 0) {
            const variantsToInsert = productVariants.map(v => ({
                product_id: savedProductId,
                custom_color: v.color,
                custom_size: v.size,
                price: v.price,
                discounted_price: v.discounted_price,
                stock: v.stock,
                sku: v.sku,
                is_custom: true
            }));
            const { error: variantError } = await db.from('variants').insert(variantsToInsert);
            if (variantError) throw variantError;
        }

        closeModal('product-modal');
        await loadProducts();
        await loadDashboard();
    } catch (error) {
        showConfirmation(`Error saving product: ${error.message}`, null, 'Error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHTML;
        hideLoader();
    }
}


function deleteProduct(productId) {
    showConfirmation('Are you sure you want to delete this product?', async () => {
        showLoader();
        try {
            await db.from('variants').delete().eq('product_id', productId);
            const { error } = await db.from('products').delete().eq('id', productId);
            if (error) throw error;
            await loadProducts();
            await loadDashboard();
        } catch (error) {
            showConfirmation(`Error deleting product: ${error.message}`, null, 'Error');
        } finally {
            hideLoader();
        }
    });
}

async function uploadToCloudinary(file, folder = 'product_images') {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
  formData.append('folder', folder);
  
  try {
    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
    if (!response.ok) throw new Error('Upload failed');
    const data = await response.json();
    return data.secure_url;
  } catch (error) {
    console.error('Error uploading image:', error);
    return null;
  }
}

function editProduct(productId) {
  const product = state.products.find(p => p.id == productId);
  if (product) {
    showAddProductForm(product);
  } else {
    console.error("Product not found for editing:", productId);
    showConfirmation("Could not find the product to edit. Please refresh and try again.", null, "Error");
  }
}

/* ===================================================================================
//
//                      -- IMPORTANT: REAL-TIME TRACKING WEBHOOK --
//
// To receive real-time status updates from Track123, you must set up a webhook.
// This cannot be done in the client-side code below. You need to:
//
// 1. CREATE A SUPABASE EDGE FUNCTION:
//    - This function will be a secure endpoint (URL) that Track123 can send updates to.
//    - It will receive POST requests with tracking data in the body.
//
// 2. CONFIGURE THE WEBHOOK IN YOUR TRACK123 DASHBOARD:
//    - Go to your Track123 account settings -> Webhooks.
//    - Add a new webhook and paste the URL of your Supabase Edge Function.
//
// 3. EDGE FUNCTION LOGIC (Example):
//    async (req) => {
//      const trackingData = await req.json();
//      // Optional: Add a secret key check to verify the request is from Track123.
//
//      const trackingNumber = trackingData.tracking_number;
//      const newStatus = trackingData.status;
//
//      // Update the 'shipments' table in Supabase
//      const { error } = await supabase
//        .from('shipments')
//        .update({ current_status: newStatus })
//        .eq('tracking_number', trackingNumber);
//
//      if (error) { // Handle error }
//
//      return new Response("OK", { status: 200 });
//    }
//
// This server-side setup is crucial for automatically updating shipment statuses
// in your panel without requiring manual refreshes.
//
// =================================================================================== */

/* ---------- ORDERS MANAGEMENT ---------- */
async function loadOrders() {
    const ordersPage = document.getElementById('orders');
    if (!state.supplier) return;
    ordersPage.innerHTML = `<div class="page-header"><h1 class="main-header">My Orders</h1></div><div class="card"><p>Loading orders...</p></div>`;
    showLoader();
    try {
        const { data: orders, error } = await db.rpc('get_orders_for_supplier', { p_supplier_id: state.supplier.id });
        if (error) throw error;
        
        let ordersWithProducts = [];
        if(orders && orders.length > 0) {
            const orderIds = orders.map(o => o.id);
            const { data: orderItems, error: itemsError } = await db.from('order_items').select('order_id, product_id').in('order_id', orderIds);
            if(itemsError) throw itemsError;

            const productIds = [...new Set(orderItems.map(item => item.product_id))];
            const { data: products, error: productsError } = await db.from('products').select('id, image_url').in('id', productIds);
            if(productsError) throw productsError;

            const productMap = new Map(products.map(p => [p.id, p]));
            
            ordersWithProducts = orders.map(order => {
                const firstItem = orderItems.find(item => item.order_id === order.id);
                const firstProduct = firstItem ? productMap.get(firstItem.product_id) : null;
                return {
                    ...order,
                    product_image_url: firstProduct ? firstProduct.image_url : 'https://via.placeholder.com/64'
                };
            });
        }
        
        state.orders = (ordersWithProducts || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        if (state.orders.length === 0) {
            ordersPage.innerHTML = `<div class="page-header"><h1 class="main-header">My Orders</h1></div><div id="no-orders-container" class="card" style="text-align: center; padding: 40px;"><h3 id="no-orders-msg">No Orders Yet</h3><p>Your orders will appear here when customers purchase your products.</p></div>`;
            return;
        }

        ordersPage.innerHTML = `
            <div class="page-header"><h1 class="main-header">My Orders</h1></div>
            <div class="card">
                <table class="content-table" id="orders-table">
                    <thead><tr><th>Product</th><th>Order ID</th><th>Date</th><th>Customer</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${state.orders.map(order => `
                            <tr data-order-id="${order.id}">
                                <td data-label="Product"><img src="${order.product_image_url}" class="product-thumbnail" /></td>
                                <td data-label="Order ID">#${order.id.toString().substring(0, 8)}</td>
                                <td data-label="Date">${new Date(order.created_at).toLocaleDateString()}</td>
                                <td data-label="Customer">${order.customer_name || 'N/A'}</td>
                                <td data-label="Total">PKR ${order.total_price || 0}</td>
                                <td data-label="Status">${order.status}</td>
                                <td data-label="Actions">
                                    <button class="btn btn-primary" style="margin-bottom: 5px;" onclick="viewOrderDetail('${order.id}')">View</button>
                                    <button class="btn btn-delete" onclick="deleteOrder('${order.id}')">Delete</button>
                                </td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
    } catch (error) {
        console.error('Error loading orders:', error);
        ordersPage.innerHTML = `<div class="error-message">Error loading orders: ${error.message}.</div>`;
    } finally {
        hideLoader();
    }
}

async function deleteOrder(orderId) {
    showConfirmation('Are you sure you want to delete this order? This action cannot be undone.', async () => {
        showLoader();
        try {
            const { error: itemError } = await db.from('order_items').delete().eq('order_id', orderId);
            if (itemError) throw itemError;

            const { error: orderError } = await db.from('orders').delete().eq('id', orderId);
            if (orderError) throw orderError;
            
            document.querySelector(`tr[data-order-id="${orderId}"]`)?.remove();
            state.orders = state.orders.filter(o => o.id !== orderId);
            await loadDashboard();
        } catch (error) {
            showConfirmation(`Error deleting order: ${error.message}`, null, 'Error');
        } finally {
            hideLoader();
        }
    });
}

function copyToClipboard(text, element) {
    if (!navigator.clipboard) {
        showConfirmation("Clipboard API not available on your browser.", null, "Error");
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        const originalHtml = element.innerHTML;
        element.innerHTML = `<span class="copy-feedback">Copied!</span>`;
        setTimeout(() => {
            element.innerHTML = originalHtml;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showConfirmation("Failed to copy text.", null, "Error");
    });
}

async function printInvoice(orderId) {
    showLoader("Generating Invoice...");
    try {
        const { data: order, error: orderError } = await db.from('orders').select('*, user:users(*)').eq('id', orderId).single();
        if (orderError) throw orderError;
        
        const { data: items, error: itemsError } = await db.from('order_items').select('*, product:products(*)').eq('order_id', orderId);
        if (itemsError) throw itemsError;

        const invoiceData = {
            order,
            items,
            supplier: state.supplier
        };

        sessionStorage.setItem('invoiceData', JSON.stringify(invoiceData));
        
        const invoiceWindow = window.open('invoice.html', '_blank');
        if (!invoiceWindow) {
            showConfirmation("Please allow pop-ups for this site to print invoices.", null, "Pop-up Blocked");
        }
        
    } catch(err) {
        showConfirmation(`Failed to generate invoice data: ${err.message}`, null, 'Error');
    } finally {
        hideLoader();
    }
}


async function viewOrderDetail(orderId) {
    const modal = document.getElementById('order-detail-modal');
    modal.innerHTML = `<div class="modal"><p>Loading details...</p></div>`;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);

    showLoader();
    try {
        const { data: order, error: orderError } = await db.from('orders').select('*').eq('id', orderId).single();
        if (orderError) throw orderError;

        const { data: shipment, error: shipmentError } = await db.from('shipments').select('*').eq('order_id', orderId).single();

        const { data: items, error: itemsError } = await db.rpc('get_order_items_for_supplier', { p_order_id: orderId, p_supplier_id: state.supplier.id });
        if (itemsError) throw itemsError;

        const productIds = items.map(item => item.product_id);
        const { data: products, error: productsError } = await db.from('products').select('*').in('id', productIds);
        if(productsError) throw productsError;

        const itemsWithProducts = items.map(item => ({
            ...item,
            products: products.find(p => p.id === item.product_id)
        }));

        let statusDisplayHtml = '';
        if (shipment && shipment.tracking_number) {
            statusDisplayHtml = `
                <h4><i class="fas fa-shipping-fast"></i> Live Shipment Status</h4>
                <p><strong>Courier:</strong> ${shipment.courier_name}</p>
                <p><strong>Tracking #:</strong> ${shipment.tracking_number} <span class="copy-icon" onclick="copyToClipboard('${shipment.tracking_number}', this)"><i class="fas fa-copy"></i></span></p>
                <p><strong>Status:</strong> <span class="status-badge" style="background-color: var(--info); text-transform: capitalize;">${shipment.current_status || 'Tracking Initiated'}</span></p>
            `;
        } else {
             statusDisplayHtml = `
                <h4><i class="fas fa-file-invoice-dollar"></i> Order Summary</h4>
                <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                <p><strong>Total:</strong> PKR ${order.total_price}</p>
                <p><strong>Status:</strong> <span id="current-order-status" style="font-weight:bold; text-transform: capitalize;">${order.status}</span></p>
            `;
        }


        const content = `
            <div class="modal">
                <h2>Order Details #${order.id.toString().substring(0, 8)}</h2>
                <div class="order-details-grid">
                    <div class="card">
                        <h4><i class="fas fa-user"></i> Customer Info</h4>
                        <p><strong>Name:</strong> ${order.customer_name} <span class="copy-icon" onclick="copyToClipboard('${order.customer_name.replace(/'/g, "\\'")}', this)"><i class="fas fa-copy"></i></span></p>
                        <p><strong>Phone:</strong> ${order.customer_phone} <span class="copy-icon" onclick="copyToClipboard('${order.customer_phone}', this)"><i class="fas fa-copy"></i></span></p>
                        <p><strong>Address:</strong> ${order.customer_address}, ${order.customer_city} <span class="copy-icon" onclick="copyToClipboard('${(order.customer_address + ", " + order.customer_city).replace(/'/g, "\\'")}', this)"><i class="fas fa-copy"></i></span></p>
                    </div>
                    <div class="card">
                        ${statusDisplayHtml}
                    </div>
                    <div class="order-details-products card">
                        <h4><i class="fas fa-box-open"></i> Products in this Order</h4>
                        ${itemsWithProducts.map(item => `
                            <div class="order-product-item">
                                <img src="${item.products.image_url || 'https://via.placeholder.com/80'}" alt="${item.products.title}">
                                <div class="order-product-details">
                                    <strong>${item.products.title}</strong>
                                    <p>Qty: ${item.quantity} | Price: PKR ${item.price}</p>
                                    <p>Size: ${item.size || 'N/A'} | Color: ${item.color || 'N/A'}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="order-status-buttons" id="order-status-buttons-container">
                    <!-- Status buttons will be rendered here -->
                </div>
            </div>
        `;
        modal.innerHTML = content;
        renderStatusButtons(order.status, shipment ? shipment.current_status : null, order.id);

    } catch (err) {
        modal.innerHTML = `<div class="modal"><div class="error-message">Failed to load order items: ${err.message}.</div> <button class="btn" onclick="closeModal('order-detail-modal')">Close</button></div>`;
    } finally {
        hideLoader();
    }
}

function renderStatusButtons(orderStatus, shipmentStatus, orderId) {
    const container = document.getElementById('order-status-buttons-container');
    if (!container) return;

    const cleanOrderStatus = orderStatus ? orderStatus.trim().toLowerCase() : '';
    let buttonsHtml = '';

    if (cleanOrderStatus === 'processing' && !shipmentStatus) {
        buttonsHtml += `<button class="btn btn-primary" onclick="showDispatchModal('${orderId}')"><i class="fas fa-shipping-fast"></i> Dispatch the Order</button>`;
    }

    buttonsHtml += `<button class="btn btn-secondary" style="margin-left: auto;" onclick="printInvoice('${orderId}')"><i class="fas fa-print"></i> Print Invoice</button>`;
    buttonsHtml += `<button class="btn btn-secondary" onclick="closeModal('order-detail-modal')">Close</button>`;

    container.innerHTML = buttonsHtml;
}

function showDispatchModal(orderId) {
    const modal = document.getElementById('dispatch-order-modal');
    modal.innerHTML = `
        <div class="modal" style="max-width: 550px;">
            <h2>Dispatch the Order</h2>
            <p>Select a courier and enter the tracking number.</p>
            <form id="dispatch-form">
                <div class="courier-selection">
                    <div class="courier-option" data-courier="Leopards" onclick="selectCourier(this)">
                        <img src="leopards.png" alt="Leopards Courier" style="background-color: #f0f0f0; border-radius: 8px; padding: 5px;">
                        <strong>Leopards</strong>
                    </div>
                    <div class="courier-option" data-courier="PostEx" onclick="selectCourier(this)">
                        <img src="postex.png" alt="PostEx Courier" style="background-color: #f0f0f0; border-radius: 8px; padding: 5px;">
                        <strong>PostEx</strong>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tracking-number">Tracking Number</label>
                    <input type="text" id="tracking-number" required>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('dispatch-order-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save and Dispatch</button>
                </div>
            </form>
        </div>
    `;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);

    document.getElementById('dispatch-form').addEventListener('submit', (e) => {
        e.preventDefault();
        handleDispatchSubmit(orderId);
    });
}

function selectCourier(element) {
    document.querySelectorAll('.courier-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
}

/**
 * FINAL, SECURE VERSION of handleDispatchSubmit.
 * This function calls the Netlify Function 'track123-proxy' which securely handles the API key
 * and communication with the Track123 API.
 */
async function handleDispatchSubmit(orderId) {
    const selectedCourierEl = document.querySelector('.courier-option.selected');
    const trackingNumber = document.getElementById('tracking-number').value.trim();

    if (!selectedCourierEl) {
        showConfirmation("Please select a courier service.", null, "Selection Required");
        return;
    }
    const courierName = selectedCourierEl.dataset.courier;

    let isValid = false;
    let courierCode = '';
    if (courierName === 'Leopards') {
        const leopardsRegex = /^[a-zA-Z0-9]{7,15}$/;
        isValid = leopardsRegex.test(trackingNumber);
        courierCode = 'leopardscourier';
    } else if (courierName === 'PostEx') {
        const postexRegex = /^\d{11,15}$/;
        isValid = postexRegex.test(trackingNumber);
        courierCode = 'postex';
    }

    if (!isValid) {
        showConfirmation(`The tracking number "${trackingNumber}" is not a valid format for ${courierName}. Please check and re-enter.`, null, "Invalid Tracking Number");
        return;
    }

    showLoader("Initiating tracking...");

    try {
        // --- Call YOUR Netlify Function ---
        const proxyResponse = await fetch(`/.netlify/functions/track123-proxy`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tracking_number: trackingNumber,
                courier_code: courierCode
            })
        });

        // --- NEW, ROBUST ERROR HANDLING ---
        // Check if the server responded with an error status (like 400, 404, 500)
        if (!proxyResponse.ok) {
            // Get the raw text of the error response
            const errorText = await proxyResponse.text(); 
            // Check if it's the HTML error page or a JSON error from our function
            if (errorText.startsWith('{')) {
                const errorJson = JSON.parse(errorText);
                throw new Error(errorJson.error || `Server error: ${proxyResponse.status}`);
            } else {
                // This will now give a clear error if Netlify returned a generic page
                throw new Error(`Function call failed with status ${proxyResponse.status}. The function may not have deployed correctly.`);
            }
        }
        
        const proxyData = await proxyResponse.json();
        
        if (proxyData.meta.code !== 200) {
             throw new Error(proxyData.meta.message || 'An error occurred with Track123.');
        }

        const initialStatus = proxyData.data?.status || 'Info Received';

        // The rest of the logic remains the same
        const { error: shipmentError } = await db.from('shipments').insert({
            order_id: orderId,
            supplier_id: state.supplier.id,
            courier_name: courierName,
            tracking_number: trackingNumber,
            current_status: initialStatus
        });
        if (shipmentError) throw shipmentError;

        const { error: orderUpdateError } = await db.from('orders').update({
            status: 'Shipped'
        }).eq('id', orderId);
        if (orderUpdateError) throw orderUpdateError;

        closeModal('dispatch-order-modal');
        await loadOrders();
        await viewOrderDetail(orderId);

    } catch (err) {
        console.error("Dispatch Error:", err);
        // This will now show the more helpful error message
        showConfirmation(`Failed to dispatch order: ${err.message}`, null, "Error");
    } finally {
        hideLoader();
    }
}

/* ---------- REVIEWS MANAGEMENT ---------- */
function generateStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            stars += '<i class="fas fa-star"></i>';
        } else if (i - 0.5 <= rating) {
            stars += '<i class="fas fa-star-half-alt"></i>';
        } else {
            stars += '<i class="far fa-star"></i>';
        }
    }
    return stars;
}

async function loadReviews() {
    const reviewsPage = document.getElementById('reviews');
    if (!state.supplier) return;
    reviewsPage.innerHTML = `<div class="page-header"><h1 class="main-header">Product Reviews</h1></div><div class="card"><p>Loading reviews...</p></div>`;
    showLoader();
    try {
        const { data: products, error: productsError } = await db.from('products').select('id').eq('supplier_id', state.supplier.id);
        if (productsError) throw productsError;
        if (!products || products.length === 0) {
             reviewsPage.innerHTML = `<div class="page-header"><h1 class="main-header">Product Reviews</h1></div><div class="card" style="text-align:center;"><p>No products found to fetch reviews for.</p></div>`;
             return;
        }
        const productIds = products.map(p => p.id);

        const { data: reviews, error: reviewsError } = await db.from('reviews').select('*, product:products(id, title, description, image_url)').in('product_id', productIds).order('created_at', { ascending: false });
        if (reviewsError) throw reviewsError;
        
        state.reviews = reviews || [];
        
        if (state.reviews.length === 0) {
            reviewsPage.innerHTML = `<div class="page-header"><h1 class="main-header">Product Reviews</h1></div><div class="card" style="text-align: center; padding: 40px;"><h3>No Reviews Yet</h3><p>Customer reviews for your products will appear here.</p></div>`;
            return;
        }

        reviewsPage.innerHTML = `
            <div class="page-header"><h1 class="main-header">Product Reviews</h1></div>
            <div class="reviews-container">
                ${state.reviews.map(review => `
                    <div class="review-card" onclick="viewReviewDetail(${review.product.id})">
                        <div class="review-header">
                            <img src="${review.product.image_url || 'https://via.placeholder.com/64'}" class="review-product-img">
                            <div>
                                <div class="review-product-name">${review.product.title}</div>
                                <div class="star-rating">${generateStars(review.rating)}</div>
                            </div>
                        </div>
                        <p class="review-comment">"${review.comment}"</p>
                        ${review.image_url ? `<img src="${review.image_url}" class="review-customer-img" alt="Review image">` : ''}
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error('Error loading reviews:', error);
        reviewsPage.innerHTML = `<div class="error-message">Error loading reviews: ${error.message}.</div>`;
    } finally {
        hideLoader();
    }
}

function viewReviewDetail(productId) {
    const product = state.reviews.find(r => r.product.id === productId)?.product;
    if (!product) {
        showConfirmation("Could not find product details for this review.", null, 'Error');
        return;
    }
    const allReviewsForProduct = state.reviews.filter(r => r.product.id === productId);

    const modal = document.getElementById('review-detail-modal');
    const content = `
        <div class="modal">
            <h2>Reviews for ${product.title}</h2>
            <div class="review-detail-layout">
                <div class="review-detail-product-card card">
                    <img src="${product.image_url}" alt="${product.title}">
                    <h4>${product.title}</h4>
                    <p><strong>Product Code:</strong> ${product.id}</p>
                    <p>${product.description}</p>
                </div>
                <div class="all-reviews-list card">
                    <h4>All Reviews (${allReviewsForProduct.length})</h4>
                    ${allReviewsForProduct.map(review => `
                        <div class="review-item">
                            <div class="star-rating">${generateStars(review.rating)}</div>
                            <p class="review-comment">"${review.comment}"</p>
                            ${review.image_url ? `<img src="${review.image_url}" class="review-customer-img" alt="Review image">` : ''}
                            <small style="color: var(--text-light);">${new Date(review.created_at).toLocaleString()}</small>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('review-detail-modal')">Close</button>
            </div>
        </div>
    `;
    modal.innerHTML = content;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
}


/* ---------- CHAT FUNCTIONALITY ---------- */
async function loadChat() {
    const chatPage = document.getElementById('chat');
    chatPage.innerHTML = `
        <div class="page-header"><h1 class="main-header">Chat with Users</h1></div>
        <div id="chat-list-container"></div>
        <div id="chat-detail-container"></div>
    `;
    showLoader();
    if (!state.user || !state.supplier?.id) {
        chatPage.querySelector('#chat-list-container').innerHTML = `<div class="error-message">Could not load chat. Supplier data is missing.</div>`;
        hideLoader();
        return;
    }

    try {
        const { data: chatSessions, error: chatsError } = await db.from('chats').select('id, user_id').eq('supplier_id', state.supplier.id);
        if (chatsError) throw chatsError;

        if (!chatSessions || chatSessions.length === 0) {
            state.chatUsers = [];
            renderChatList();
            return;
        }

        const userIds = chatSessions.map(c => c.user_id);
        
        const { data: usersData, error: usersError } = await db.from('users')
            .select('id, brand_name, first_name, last_name, profile_pic')
            .in('id', userIds);

        if (usersError) throw usersError;
        
        const userDetails = new Map(usersData?.map(u => [u.id, u]));

        const chatIds = chatSessions.map(c => c.id);
        const { data: messages, error: messagesError } = await db.from('chat_messages').select('*, status').in('chat_id', chatIds).order('created_at', { ascending: true });
        if (messagesError) throw messagesError;
        state.messages = messages || [];

        state.chatUsers = chatSessions.map(session => {
            const userMessages = state.messages.filter(m => m.chat_id === session.id);
            const lastMessage = userMessages.length > 0 ? userMessages[userMessages.length - 1] : null;
            const unreadCount = userMessages.filter(m => m.sender_id === session.user_id && m.status !== 'seen').length;
            const user = userDetails.get(session.user_id) || {};
            
            const displayName = user.brand_name 
                                || (user.first_name && user.last_name ? `${user.first_name} ${user.last_name}`.trim() : user.first_name)
                                || `User (${session.user_id.substring(0, 6)}...)`;
            
            return {
                id: session.user_id,
                chat_id: session.id,
                name: displayName,
                profile_pic: user.profile_pic,
                lastMessage: lastMessage?.message_text || 'No messages yet.',
                unread: unreadCount,
                lastMessageTimestamp: lastMessage ? lastMessage.created_at : session.created_at
            };
        }).sort((a,b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));

        renderChatList();
    } catch (error) {
        console.error('Error in loadChat:', error);
        chatPage.querySelector('#chat-list-container').innerHTML = `<div class="error-message">Error loading chat: ${error.message}</div>`;
    } finally {
        hideLoader();
    }
}


function renderChatList() {
    const container = document.getElementById('chat-list-container');
    if (!container) return;
    
    container.style.display = 'block';
    const detailContainer = document.getElementById('chat-detail-container');
    if (detailContainer) detailContainer.style.display = 'none';

    if (state.chatUsers.length === 0) {
        container.innerHTML = `<div class="card" style="text-align: center; padding: 40px;"><h3>No Conversations</h3><p>Your conversations with users will appear here.</p></div>`;
        return;
    }
    
    container.innerHTML = `
        <div class="card">
            <ul class="conversation-list">
                ${state.chatUsers.map(user => `
                    <li class="conversation-item" onclick="openChatDetail('${user.id}')">
                        <div class="animated-gradient-border" onclick="event.stopPropagation(); if ('${user.profile_pic}') showImageModal('${user.profile_pic}');">
                            <div class="conversation-avatar">${renderProfilePicture(user, 'chat')}</div>
                        </div>
                        <div class="conversation-details">
                            <div class="conversation-name">${user.name}</div>
                            <div class="conversation-last-message">${user.lastMessage}</div>
                        </div>
                        ${user.unread > 0 ? `<div class="unread-badge">${user.unread}</div>` : ''}
                    </li>
                `).join('')}
            </ul>
        </div>
    `;
}

function openChatDetail(userId) {
    const user = state.chatUsers.find(u => u.id === userId);
    if (!user) return;
    
    state.activeChatUser = user;

    document.getElementById('chat-list-container').style.display = 'none';
    const detailContainer = document.getElementById('chat-detail-container');
    detailContainer.style.display = 'flex';
    
    detailContainer.innerHTML = `
        <div class="chat-detail-header" onclick="showUserProfilePage('${user.id}')">
            <button class="chat-back-btn" onclick="event.stopPropagation(); closeChatDetail();"><i class="fas fa-arrow-left"></i></button>
            <div class="conversation-avatar" style="width: 40px; height: 40px; font-size: 1.2rem; margin-right: 10px;" onclick="event.stopPropagation(); if ('${user.profile_pic}') showImageModal('${user.profile_pic}');">
                ${renderProfilePicture(user, 'chat')}
            </div>
            <h3>${user.name}</h3>
        </div>
        <div class="chat-messages" id="chat-messages-area"></div>
        <div class="chat-input-area">
            <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleMessageKeypress(event)">
            <button class="btn send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    `;
    
    renderChatMessages(user.chat_id);
    markMessagesAsSeen(user.chat_id, user.id);
}

function closeChatDetail() {
    state.activeChatUser = null;
    document.getElementById('chat-detail-container').style.display = 'none';
    document.getElementById('chat-list-container').style.display = 'block';
    loadChat(); 
}

function getFormattedDate(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const messageDate = new Date(date);
    
    if (messageDate.toDateString() === today.toDateString()) return 'Today';
    if (messageDate.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return messageDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

function renderChatMessages(chatId) {
    const container = document.getElementById('chat-messages-area');
    if (!container) return;
    
    let lastDateString = null;
    let messagesHtml = '';

    state.messages
        .filter(m => m.chat_id === chatId)
        .forEach(message => {
            const messageDate = new Date(message.created_at);
            const currentDateString = messageDate.toDateString();

            if (currentDateString !== lastDateString) {
                messagesHtml += `<div class="date-separator"><span>${getFormattedDate(messageDate)}</span></div>`;
                lastDateString = currentDateString;
            }

            const isSentBySupplier = message.sender_id === state.user.id;
            const messageClass = isSentBySupplier ? 'sent-by-supplier' : 'received-from-user';
            
            let ticks = '';
            if (isSentBySupplier) {
                 switch (message.status) {
                    case 'seen': ticks = `<span class="message-ticks seen"><i class="fas fa-check-double"></i></span>`; break;
                    case 'delivered': ticks = `<span class="message-ticks"><i class="fas fa-check-double"></i></span>`; break;
                    case 'sent': ticks = `<span class="message-ticks"><i class="fas fa-check"></i></span>`; break;
                    default: ticks = `<span class="message-ticks"><i class="far fa-clock"></i></span>`;
                }
            }

            messagesHtml += `
                <div class="message ${messageClass}" data-message-id="${message.id}">
                    <div class="message-content">${message.message_text}</div>
                    <div class="message-meta">
                        <span>${messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        ${ticks}
                    </div>
                </div>`;
        });
        
    container.innerHTML = messagesHtml;
    container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    if (!content || !state.activeChatUser) return;

    if (containsProhibitedContent(content)) {
        showConfirmation('Messages cannot contain contact numbers, links, or social media handles.', null, 'Content Policy');
        return;
    }
    
    const optimisticMessage = {
        id: `temp_${Date.now()}`,
        chat_id: state.activeChatUser.chat_id,
        sender_id: state.user.id,
        recipient_id: state.activeChatUser.id,
        message_text: content,
        status: 'sending',
        created_at: new Date().toISOString()
    };
    
    state.messages.push(optimisticMessage);
    appendMessageToChat(optimisticMessage);
    input.value = '';

    try {
        const messageToSend = {
            chat_id: optimisticMessage.chat_id,
            sender_id: optimisticMessage.sender_id,
            recipient_id: optimisticMessage.recipient_id,
            message_text: optimisticMessage.message_text,
            status: 'sent'
        };

        const { data, error } = await db.from('chat_messages').insert(messageToSend).select().single();
        if (error) throw error;

        const messageIndex = state.messages.findIndex(m => m.id === optimisticMessage.id);
        if(messageIndex > -1) {
             state.messages[messageIndex] = data;
             renderChatMessages(optimisticMessage.chat_id);
        }

    } catch (error) {
        console.error('Error sending message:', error);
        state.messages = state.messages.filter(m => m.id !== optimisticMessage.id);
        renderChatMessages(optimisticMessage.chat_id);
        showConfirmation(`Failed to send message: ${error.message}`, null, 'Error');
    }
}


async function markMessagesAsSeen(chatId, fromUserId) {
  try {
    const { error } = await db.from('chat_messages')
      .update({ status: 'seen' })
      .eq('chat_id', chatId)
      .eq('sender_id', fromUserId)
      .in('status', ['sent', 'delivered']);

    if (error) throw error;
    
    state.messages.forEach(msg => {
        if (msg.chat_id === chatId && msg.sender_id === fromUserId) msg.status = 'seen';
    });
    const userInState = state.chatUsers.find(u => u.id === fromUserId);
    if (userInState) userInState.unread = 0;
    
    checkAllNotifications();
  } catch (error) {
    console.error('Error marking messages as read:', error);
  }
}

function handleMessageKeypress(e) { if (e.key === 'Enter') sendMessage(); }

function containsProhibitedContent(text) {
  const phoneRegex = /(\+?\d{1,3}[-.\s]?)?\(?\d{1,4}\)?[-.\s]?\d{1,4}[-.\s]?\d{1,9}/g;
  const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)/g;
  const socialRegex = /@\w+/g;
  return phoneRegex.test(text) || urlRegex.test(text) || socialRegex.test(text);
}


/* ---------- OTHER PAGES ---------- */
function loadAccount() {
    const accountPage = document.getElementById('account');
    const s = state.supplier;
    
    let verificationBadgeHtml = '';
    const status = s.verified_status || 'Unverified';

    switch(status.toLowerCase()) {
        case 'verified':
            verificationBadgeHtml = `<div class="verification-badge verified-badge" title="Verified"><i class="fas fa-check"></i></div>`;
            break;
        case 'unverified':
            verificationBadgeHtml = `<div class="verification-badge unverified-badge" title="Unverified"><i class="fas fa-times"></i></div>`;
            break;
        case 'under review':
            verificationBadgeHtml = `<div class="verification-badge under-review-badge" title="Under Review"><i class="fas fa-clock"></i></div>`;
            break;
    }

    accountPage.innerHTML = `
        <div class="page-header"><h1 class="main-header">Your Account</h1></div>
        <div class="card">
            <div class="profile-pic-uploader animated-gradient-border">
                ${renderProfilePicture(s, 'account')}
                ${verificationBadgeHtml}
                <label for="account-profile-pic-file"><i class="fas fa-camera"></i></label>
                <input type="file" id="account-profile-pic-file" accept="image/*" onchange="previewProfileImage(this, 'account-profile-pic-preview')">
            </div>
            <form id="account-form">
                <div class="form-grid">
                    <div class="form-group"><label for="acc-fn">Full Name</label><input type="text" id="acc-fn" value="${s.full_name||''}" required></div>
                    <div class="form-group"><label for="acc-bn">Brand Name</label><input type="text" id="acc-bn" value="${s.brand_name||''}" required></div>
                    <div class="form-group"><label for="acc-em">Email</label><input type="email" id="acc-em" value="${s.email||''}" disabled></div>
                    <div class="form-group"><label for="acc-cn">Phone</label><input type="text" id="acc-cn" value="${s.contact_number||''}" required></div>
                    <div class="form-group"><label for="acc-ct">City</label><input type="text" id="acc-ct" value="${s.city||''}" required></div>
                    <div class="form-group"><label for="acc-ad">Address</label><input type="text" id="acc-ad" value="${s.address||''}" required></div>
                </div>
                <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn btn-primary">Update Profile</button></div>
                <div id="account-message" style="margin-top: 15px;"></div>
            </form>
        </div>`;
        
    document.getElementById('account-form').addEventListener('submit', handleUpdateAccount);
}


async function handleUpdateAccount(e) {
    e.preventDefault();
    const messageDiv = document.getElementById('account-message');
    const profilePicFile = document.getElementById('account-profile-pic-file').files[0];
    
    const updatedData = {
        full_name: document.getElementById('acc-fn').value, 
        brand_name: document.getElementById('acc-bn').value,
        contact_number: document.getElementById('acc-cn').value, 
        city: document.getElementById('acc-ct').value,
        address: document.getElementById('acc-ad').value,
    };
    showLoader();
    try {
        if(profilePicFile) {
            const profilePicUrl = await uploadToCloudinary(profilePicFile, 'profile_pictures');
            updatedData.profile_pic = profilePicUrl;
        }

        const { data, error } = await db.from('suppliers').update(updatedData).eq('id', state.supplier.id).select().single();
        if (error) throw error;
        state.supplier = data;
        messageDiv.innerHTML = `<div class="success-message">Account updated successfully!</div>`;
        loadAccount();
    } catch (error) {
        messageDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
    } finally {
        hideLoader();
    }
}

async function calculateSupplierEarnings() {
    if (!state.supplier) return { totalEarnings: 0, totalWithdrawn: 0, availableBalance: 0 };

    const { data: deliveredOrders, error: ordersError } = await db.rpc('get_orders_for_supplier', { p_supplier_id: state.supplier.id });
    if (ordersError) throw ordersError;
    const totalEarnings = (deliveredOrders || [])
        .filter(order => order.status === 'Delivered')
        .reduce((sum, order) => sum + (order.total_price || 0), 0);

    const { data: successfulWithdrawals, error: withdrawalsError } = await db
        .from('supplier_withdrawals')
        .select('amount')
        .eq('supplier_id', state.supplier.id)
        .eq('status', 'successful');
    if (withdrawalsError) throw withdrawalsError;
    const totalWithdrawn = successfulWithdrawals.reduce((sum, w) => sum + w.amount, 0);

    const availableBalance = totalEarnings - totalWithdrawn;

    state.earnings = { totalEarnings, totalWithdrawn, availableBalance };
    return state.earnings;
}


async function loadPayment() {
    const page = document.getElementById('payment');
    page.innerHTML = `<div class="page-header"><h1 class="main-header">Payment & Withdrawals</h1></div><div class="card"><p>Loading payment information...</p></div>`;
    showLoader('Checking payment status...');
    try {
        const { data: paymentMethods, error: methodsError } = await db.from('supplier_payment_methods').select('id').eq('supplier_id', state.supplier.id).limit(1);
        if (methodsError) throw methodsError;

        if (paymentMethods.length === 0) {
            page.innerHTML = `
                <div class="page-header"><h1 class="main-header">Payment & Withdrawals</h1></div>
                <div class="card add-account-container">
                    <i class="fas fa-credit-card"></i>
                    <h3>No Payment Method Found</h3>
                    <p>Please add a payment method to receive your earnings.</p>
                    <button class="btn btn-primary" onclick="showAddPaymentMethodModal()">Add Account</button>
                </div>
            `;
        } else {
            await calculateSupplierEarnings();
            const { data: withdrawals, error: withdrawalsError } = await db
                .from('supplier_withdrawals')
                .select('*, payment_method:supplier_payment_methods(*)')
                .eq('supplier_id', state.supplier.id)
                .order('requested_at', { ascending: false });
            if (withdrawalsError) throw withdrawalsError;

            page.innerHTML = `
                <div class="page-header">
                    <h1 class="main-header">Payment & Withdrawals</h1>
                    <button class="btn btn-primary" onclick="showWithdrawalModal()"><i class="fas fa-hand-holding-usd"></i> Request Withdrawal</button>
                </div>
                <div class="earnings-summary-container">
                    <div class="summary-card paid"><h3>Total Paid</h3><p>PKR ${state.earnings.totalWithdrawn.toLocaleString()}</p></div>
                    <div class="summary-card balance"><h3>Remaining Balance</h3><p>PKR ${state.earnings.availableBalance.toLocaleString()}</p></div>
                </div>
                <div class="card">
                    <h3>Transaction History</h3>
                    ${withdrawals.length > 0 ? `
                    <table class="content-table">
                        <thead><tr><th>Request Date</th><th>Amount</th><th>Status</th><th>Payment To</th></tr></thead>
                        <tbody>
                            ${withdrawals.map(w => `
                                <tr>
                                    <td data-label="Date">${new Date(w.requested_at).toLocaleString()}</td>
                                    <td data-label="Amount">PKR ${w.amount.toLocaleString()}</td>
                                    <td data-label="Status"><span class="status-badge ${w.status}">${w.status}</span></td>
                                    <td data-label="Payment To">${w.payment_method ? `${w.payment_method.provider_name} (${w.payment_method.account_number})` : 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` : `<p style="text-align:center; padding: 20px;">No withdrawal requests yet.</p>`}
                </div>`;
        }
    } catch (err) {
        page.innerHTML = `<div class="error-message">Error loading payment info: ${err.message}</div>`;
    } finally {
        hideLoader();
    }
}

function showAddPaymentMethodModal() {
    const modal = document.getElementById('add-payment-modal');
    modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <h2>Add Payment Method</h2>
            <form id="add-payment-form">
                <div class="form-group">
                    <label for="payment-provider">Provider</label>
                    <select id="payment-provider" required>
                        <option value="">Select Provider...</option>
                        <option value="EasyPaisa">EasyPaisa</option>
                        <option value="JazzCash">JazzCash</option>
                        <option value="U-Paisa">U-Paisa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="account-name">Account Holder Name</label>
                    <input type="text" id="account-name" required>
                </div>
                 <div class="form-group">
                    <label for="account-number">Account Number</label>
                    <input type="text" id="account-number" required>
                </div>
                <div style="text-align:right; margin-top:20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-payment-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Method</button>
                </div>
            </form>
        </div>
    `;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
    document.getElementById('add-payment-form').addEventListener('submit', handleSavePaymentMethod);
}

async function handleSavePaymentMethod(event) {
    event.preventDefault();
    showLoader("Saving...");
    try {
        const paymentData = {
            supplier_id: state.supplier.id,
            provider_name: document.getElementById('payment-provider').value,
            account_holder_name: document.getElementById('account-name').value,
            account_number: document.getElementById('account-number').value,
        };
        const { error } = await db.from('supplier_payment_methods').insert(paymentData);
        if (error) throw error;
        
        closeModal('add-payment-modal');
        await loadPayment();
    } catch (err) {
        showConfirmation(`Error saving payment method: ${err.message}`, null, 'Error');
    } finally {
        hideLoader();
    }
}


async function showWithdrawalModal() {
    await calculateSupplierEarnings();
    const { availableBalance } = state.earnings;
    if (availableBalance <= 0) {
        showConfirmation("You do not have any funds available for withdrawal.", null, "No Balance");
        return;
    }

    const { data: paymentMethods, error } = await db.from('supplier_payment_methods').select('*').eq('supplier_id', state.supplier.id);
    if (error) {
        showConfirmation(`Error fetching payment methods: ${error.message}`, null, 'Error');
        return;
    }
    if (paymentMethods.length === 0) {
        showConfirmation("Please add a payment method in your account before requesting a withdrawal.", null, "No Payment Method");
        return;
    }

    const modal = document.getElementById('withdrawal-modal');
    modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <h2>Request a Withdrawal</h2>
            <form id="withdrawal-form">
                <p>Available Balance: <strong>PKR ${availableBalance.toLocaleString()}</strong></p>
                <div class="form-group">
                    <label for="withdrawal-amount">Amount to Withdraw (PKR)</label>
                    <input type="number" id="withdrawal-amount" max="${availableBalance}" step="1" required>
                </div>
                <div class="form-group">
                    <label for="payment-method-select">Withdraw To</label>
                    <select id="payment-method-select" required>
                        ${paymentMethods.map(p => `<option value="${p.id}">${p.provider_name} - ${p.account_number}</option>`).join('')}
                    </select>
                </div>
                <div style="text-align:right; margin-top:20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('withdrawal-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </div>
            </form>
        </div>
    `;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
    document.getElementById('withdrawal-form').addEventListener('submit', handleWithdrawalRequest);
}

async function handleWithdrawalRequest(event) {
    event.preventDefault();
    const amount = parseFloat(document.getElementById('withdrawal-amount').value);
    const paymentMethodId = document.getElementById('payment-method-select').value;
    const { availableBalance } = state.earnings;

    if (isNaN(amount) || amount <= 0) {
        showConfirmation("Please enter a valid amount.", null, "Invalid Amount");
        return;
    }
    if (amount > availableBalance) {
        showConfirmation("Withdrawal amount cannot be greater than your available balance.", null, "Insufficient Balance");
        return;
    }
    
    showLoader("Submitting request...");
    try {
        const { error } = await db.from('supplier_withdrawals').insert({
            supplier_id: state.supplier.id,
            amount: amount,
            payment_method_id: paymentMethodId,
            status: 'Processing' 
        });
        if (error) throw error;
        
        closeModal('withdrawal-modal');
        showConfirmation("Your withdrawal request has been submitted successfully. You will be notified once it is processed.", null, "Success");
        await loadPayment();
    } catch (err) {
        showConfirmation(`Error submitting request: ${err.message}`, null, 'Error');
    } finally {
        hideLoader();
    }
}


/* ---------- NOTIFICATIONS ---------- */
async function checkAllNotifications() {
    if (!state.supplier || !state.user) return;
    try {
        const ordersRpcResult = await db.rpc('get_orders_for_supplier', { p_supplier_id: state.supplier.id });
        if (ordersRpcResult.error) throw ordersRpcResult.error;
        const orderIds = (ordersRpcResult.data || []).map(o => o.id);
        
        let hasNewOrders = false;
        if (orderIds.length > 0) {
            const lastSeenOrderId = localStorage.getItem('lastSeenOrderId') || '0';
            const { data: latestOrder, error: ordersError } = await db.from('orders').select('id').in('id', orderIds).order('id', { ascending: false }).limit(1).single();
            if (!ordersError && latestOrder && latestOrder.id > parseInt(lastSeenOrderId)) hasNewOrders = true;
        }
        document.querySelector('a[href="#orders"] .notification-dot').style.display = hasNewOrders ? 'block' : 'none';

        const { count: unreadChatCount } = await db.from('chat_messages').select('*', { count: 'exact', head: true }).eq('recipient_id', state.user.id).neq('status', 'seen');
        document.querySelector('a[href="#chat"] .notification-dot').style.display = (unreadChatCount > 0) ? 'block' : 'none';
        
    } catch(error) {
        console.error("Error checking notifications:", error);
    }
}


/* ---------- REALTIME SUBSCRIPTIONS ---------- */
function setupRealtimeSubscription() {
    if (realtimeChannel) db.removeChannel(realtimeChannel);
    realtimeChannel = db.channel('supplier-updates')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, async (payload) => {
            if (payload.eventType === 'INSERT' && payload.new.recipient_id === state.user.id) {
                const newMessage = payload.new;
                await db.from('chat_messages').update({ status: 'delivered' }).eq('id', newMessage.id);
                state.messages.push(newMessage);
                const isChatActive = state.activeChatUser && state.activeChatUser.chat_id === newMessage.chat_id;
                
                if (isChatActive) {
                    appendMessageToChat(newMessage); 
                    await markMessagesAsSeen(newMessage.chat_id, newMessage.sender_id);
                } else {
                    const chatUser = state.chatUsers.find(u => u.chat_id === newMessage.chat_id);
                    const senderName = chatUser ? chatUser.name : 'A user';
                    showNotification(`New message from ${senderName}`, { body: newMessage.message_text, icon: 'logo.gif' });
                    if (document.getElementById('chat').classList.contains('active')) loadChat(); 
                    else checkAllNotifications();
                }
            }
            if (payload.eventType === 'UPDATE') {
                const updatedMessage = payload.new;
                const messageIndex = state.messages.findIndex(m => m.id === updatedMessage.id);
                if (messageIndex > -1) {
                    state.messages[messageIndex] = { ...state.messages[messageIndex], ...updatedMessage };
                    if (state.activeChatUser && state.activeChatUser.chat_id === updatedMessage.chat_id) {
                        renderChatMessages(updatedMessage.chat_id);
                    }
                }
            }
        })
        .subscribe();
}
async function requestNotificationPermission() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') await Notification.requestPermission();
}

function showNotification(title, options) {
    if (Notification.permission === 'granted' && document.hidden) new Notification(title, options);
}

function appendMessageToChat(message) {
    const container = document.getElementById('chat-messages-area');
    if (container) renderChatMessages(message.chat_id);
}

/* ---------- START: VERIFICATION & OCR FUNCTIONS ---------- */
function toggleVerificationFields() {
    const gender = document.getElementById('business-gender').value;
    document.getElementById('men-verification').style.display = gender === 'men' ? 'block' : 'none';
    document.getElementById('women-unisex-verification').style.display = (gender === 'women' || gender === 'unisex') ? 'block' : 'none';
}

function previewImage(input, previewId) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            const preview = document.getElementById(previewId);
            preview.src = e.target.result;
            preview.style.display = 'block';
        }
        reader.readAsDataURL(file);
    }
}

function previewProfileImage(input, previewId) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(previewId.replace('-preview', '-placeholder'));
            preview.src = e.target.result;
            preview.style.display = 'block';
            if(placeholder) placeholder.style.display = 'none';
        }
        reader.readAsDataURL(file);
    }
}

/* ---------- PRODUCT MODAL & VARIANT SYSTEM ---------- */
async function fetchAndLoadVariants(productId) {
    const { data, error } = await db.from('variants').select('*').eq('product_id', productId);
    if (error) {
        console.error('Error fetching variants:', error);
        return;
    }
    productVariants = data.map(v => ({
        id: v.id, color: v.custom_color, size: v.custom_size, price: v.price,
        discounted_price: v.discounted_price, stock: v.stock, sku: v.sku
    }));
    renderVariantDisplay();
}

function openVariantManager() {
    tempSelectedColor = null;
    const modal = document.getElementById('variant-modal');
    const content = `
        <div class="modal">
            <h2>Product Variants Manager</h2>
            <div class="variant-layout">
                <div class="variant-steps">
                    <div class="variant-step" style="animation-delay: 0s;">
                        <h3><i class="fas fa-palette"></i> 1. Select Color</h3>
                        <input type="text" id="color-search" placeholder="Search colors..." oninput="filterColors()">
                        <div id="color-grid"></div>
                        <p style="margin-top: 10px; font-weight: 500;">Selected: <span id="selected-color-name">None</span></p>
                    </div>
                    <div class="variant-step" style="animation-delay: 0.1s;">
                        <h3><i class="fas fa-ruler-combined"></i> 2. Define Size / Type</h3>
                        <div class="form-group">
                            <select id="size-category-selector" onchange="renderSizeInputs()">
                                <option value="">Choose a product type...</option>
                                <option value="stitched_cloth">Stitched Apparel</option>
                                <option value="number_based">Number-Based (Shoes, Trousers)</option>
                                <option value="womens_handbags">Women's Handbags (Dimensions)</option>
                                <option value="jewelry">Jewelry (Dimensions)</option>
                                <option value="kitchenware">Kitchenware</option>
                                <option value="custom">Custom Value</option>
                            </select>
                        </div>
                        <div id="size-inputs-container"></div>
                    </div>
                </div>
                <div class="variant-results">
                    <h3><i class="fas fa-tasks"></i> Variant Combination</h3>
                    <div class="variant-step" style="animation-delay: 0.2s;">
                        <h4><i class="fas fa-tags"></i> 3. Add Details & Price</h4>
                        <div class="variant-details-grid">
                            <div class="form-group"><label>Price (PKR)</label><input type="number" id="variant-price" placeholder="1500"></div>
                            <div class="form-group"><label>Discounted Price</label><input type="number" id="variant-discounted-price" placeholder="1200"></div>
                            <div class="form-group"><label>Stock</label><input type="number" id="variant-stock" placeholder="50"></div>
                            <div class="form-group"><label>SKU</label><input type="text" id="variant-sku" placeholder="Optional"></div>
                        </div>
                        <button type="button" class="btn btn-success" onclick="addVariantToList()" style="width: 100%; margin-top: 15px;"><i class="fas fa-plus"></i> Add Variant to List</button>
                    </div>
                    <div id="current-variants-list" style="margin-top:20px;"></div>
                </div>
            </div>
            <div style="text-align:right; margin-top:20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <button class="btn btn-primary" onclick="saveVariantsAndClose()">Confirm & Close</button>
            </div>
        </div>
    `;
    modal.innerHTML = content;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
    renderColorGrid();
    renderCurrentVariantsList();
}

function renderColorGrid(filter = '') {
    const grid = document.getElementById('color-grid');
    if (!grid) return;
    const lowerFilter = filter.toLowerCase();
    const filteredColors = colorFamilies.filter(c => c.name.toLowerCase().includes(lowerFilter));
    let finalHtml = `<div class="color-item" onclick="selectColor('Multi-color', this)">
        <div class="color-swatch" style="background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);"></div>
        <span class="color-name">Multi-color</span>
    </div>`;
    finalHtml += filteredColors.map(color => `
        <div class="color-item" onclick="selectColor('${color.name}', this)">
            <div class="color-swatch" style="background-color: ${color.hex};"></div>
            <span class="color-name">${color.name}</span>
        </div>
    `).join('');
    grid.innerHTML = finalHtml;
}

function filterColors() {
    const searchTerm = document.getElementById('color-search').value;
    renderColorGrid(searchTerm);
}

function selectColor(name, element) {
    tempSelectedColor = name;
    document.getElementById('selected-color-name').textContent = name;
    document.querySelectorAll('#color-grid .color-item').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
}

function renderSizeInputs() {
    const category = document.getElementById('size-category-selector').value;
    const container = document.getElementById('size-inputs-container');
    let html = '';
    switch (category) {
        case 'stitched_cloth': html = `<div class="form-group"><label>Standard Size</label><select id="stitched-size"><option>Extra Small</option><option>Small</option><option>Medium</option><option>Large</option><option>Extra Large</option><option>XXL</option></select></div>`; break;
        case 'number_based': html = `<div class="form-group"><label>Numerical/Standard Size</label><input type="text" id="number-size" placeholder="e.g., 8, 32, XL"></div>`; break;
        case 'womens_handbags': html = `<label>Dimensions</label><div style="display:flex; gap:5px;"><input type="number" id="dim-l" placeholder="L"><input type="number" id="dim-w" placeholder="W"><input type="number" id="dim-h" placeholder="H"><select id="dim-unit"><option value="in">in</option><option value="cm">cm</option></select></div>`; break;
        case 'jewelry': html = `<label>Dimensions</label><div style="display:flex; gap:5px;"><input type="number" id="jewel-dim1" placeholder="e.g., Length"><input type="number" id="jewel-dim2" placeholder="e.g., Thickness"><select id="jewel-unit"><option value="cm">cm</option><option value="mm">mm</option></select></div>`; break;
        case 'kitchenware': html = `<label>Capacity</label><div style="display:flex; gap:5px;"><input type="number" id="kit-cap" placeholder="e.g., 1.5"><select id="kit-cap-unit"><option value="L">L</option><option value="kg">kg</option><option value="ml">ml</option></select></div><label>Pack Of</label><input type="number" id="kit-pack" placeholder="e.g., 6">`; break;
        case 'custom': html = `<div class="form-group"><label>Custom Value</label><input type="text" id="custom-size" placeholder="Enter custom value"></div>`; break;
    }
    container.innerHTML = html;
}

function addVariantToList() {
    if (!tempSelectedColor) { showConfirmation('Please select a color.', null, 'Missing Information'); return; }
    const sizeCategory = document.getElementById('size-category-selector').value;
    let sizeString = '';
    
    switch (sizeCategory) {
        case 'stitched_cloth': sizeString = document.getElementById('stitched-size').value; break;
        case 'number_based': sizeString = document.getElementById('number-size').value; break;
        case 'womens_handbags': sizeString = `${document.getElementById('dim-l').value}x${document.getElementById('dim-w').value}x${document.getElementById('dim-h').value} ${document.getElementById('dim-unit').value}`; break;
        case 'jewelry': sizeString = `${document.getElementById('jewel-dim1').value} x ${document.getElementById('jewel-dim2').value} ${document.getElementById('jewel-unit').value}`; break;
        case 'kitchenware': const capacity = `${document.getElementById('kit-cap').value}${document.getElementById('kit-cap-unit').value}`; const pack = `Pack of ${document.getElementById('kit-pack').value}`; sizeString = `${capacity}, ${pack}`; break;
        case 'custom': sizeString = document.getElementById('custom-size').value; break;
        default: showConfirmation('Please select a product type to define the size.', null, 'Missing Information'); return;
    }
    if (!sizeString || sizeString.trim() === '' || sizeString.includes('undefined')) { showConfirmation('Please define a size for the variant.', null, 'Missing Information'); return; }

    const price = document.getElementById('variant-price').value;
    const discounted_price = document.getElementById('variant-discounted-price').value;
    const stock = document.getElementById('variant-stock').value;
    if (!price || !stock) { showConfirmation('Please enter price and stock for the variant.', null, 'Missing Information'); return; }
    
    productVariants.push({
        color: tempSelectedColor, size: sizeString.trim(), price: parseFloat(price),
        discounted_price: discounted_price ? parseFloat(discounted_price) : null,
        stock: parseInt(stock), sku: document.getElementById('variant-sku').value
    });

    renderCurrentVariantsList();
    ['variant-price', 'variant-discounted-price', 'variant-stock', 'variant-sku'].forEach(id => document.getElementById(id).value = '');
}

function renderCurrentVariantsList() {
    const container = document.getElementById('current-variants-list');
    if (!container) return;
    if (productVariants.length === 0) {
        container.innerHTML = '<p style="text-align:center; color: var(--text-light); margin-top: 2rem;">Your added variants will appear here.</p>';
        return;
    }
    container.innerHTML = `
        <h4>Current Variants (${productVariants.length})</h4>
        <table><thead><tr><th>Color</th><th>Size</th><th>Price</th><th>Stock</th><th></th></tr></thead>
        <tbody>
            ${productVariants.map((v, index) => `
                <tr>
                    <td>${v.color}</td>
                    <td>${v.size}</td>
                    <td>${v.discounted_price ? `<del>PKR ${v.price}</del> <strong>PKR ${v.discounted_price}</strong>` : `PKR ${v.price}`}</td>
                    <td>${v.stock}</td>
                    <td><button class="btn btn-delete" style="padding: 5px 10px;" onclick="removeVariant(${index})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('')}
        </tbody>
        </table>
    `;
}

function removeVariant(index) {
    productVariants.splice(index, 1);
    renderCurrentVariantsList();
}

function saveVariantsAndClose() {
    renderVariantDisplay();
    closeModal('variant-modal');
}

function renderVariantDisplay() {
    const container = document.getElementById('variant-display-area');
    if(!container) return;
    if (productVariants.length > 0) {
        container.innerHTML = `<strong>${productVariants.length} variants configured.</strong> Click "Manage Variants" to edit.`;
    } else {
        container.innerHTML = 'No variants added. The base price and stock will be used.';
    }
}

/* ---------- PROMOTIONS MANAGEMENT START ---------- */
async function deleteOldPromotions() {
    if (!state.supplier?.id) return;
    try {
        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
        const { error } = await db.from('promoted_products')
            .delete()
            .lt('created_at', thirtyDaysAgo)
            .eq('supplier_id', state.supplier.id);

        if (error) {
            console.error("Error deleting old promotions:", error.message);
        }
    } catch (err) {
        console.error("Exception in deleteOldPromotions:", err);
    }
}

async function loadPromotions() {
    const page = document.getElementById('promotions');
    if (!state.supplier) return;
    page.innerHTML = `<div class="page-header"><h1 class="main-header">Your Promotions</h1><button class="btn btn-primary" onclick="openPromotionRequestModal()">Request New Promotion</button></div><div class="card"><p>Loading promotion history...</p></div>`;
    showLoader();
    try {
        await deleteOldPromotions();

        const { data, error } = await db.from('promoted_products')
            .select('*, product:products(id, title, image_url)')
            .eq('supplier_id', state.supplier.id)
            .order('created_at', { ascending: false });

        if (error) throw error;
        state.promotions = data || [];
        
        const noteHtml = `<div class="promotion-important-note"><strong>Important Note:</strong> Your promotion history will be deleted after 30 days.</div>`;
        let content = `<div class="card">${noteHtml}`;
        if (state.promotions.length === 0) {
            content += `<div style="text-align: center; padding: 40px;"><h3>No Promotions Yet</h3><p>Click "Request New Promotion" to boost your product's visibility.</p></div>`;
        } else {
            content += `
                <table class="content-table">
                    <thead><tr><th>Product</th><th>End Date</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${state.promotions.map(p => `
                            <tr>
                                <td data-label="Product">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <img src="${p.product.image_url || 'https://via.placeholder.com/64'}" class="product-thumbnail">
                                        <span>${p.product.title}</span>
                                    </div>
                                </td>
                                <td data-label="End Date">${new Date(p.end_date).toLocaleDateString()}</td>
                                <td data-label="Price">PKR ${p.price_paid}</td>
                                <td data-label="Status">${renderPromotionStatusBadge(p.payment_status, p.end_date)}</td>
                                <td data-label="Actions">
                                    <button class="btn btn-view" onclick="viewPromotionDetails(${p.id})">View</button>
                                    ${p.payment_status === 'pending_approval'
                                        ? `<button class="btn btn-success" onclick="showPaymentInfoModal(${p.price_paid})">Pay Now</button>`
                                        : ''
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        content += `</div>`;
        page.innerHTML = `<div class="page-header"><h1 class="main-header">Your Promotions</h1><button class="btn btn-primary" onclick="openPromotionRequestModal()">Request New Promotion</button></div>${content}`;
    } catch (err) {
        console.error('Error loading promotions:', err);
        page.innerHTML = `<div class="error-message">Error loading promotions: ${err.message}.</div>`;
    } finally {
        hideLoader();
    }
}

function renderPromotionStatusBadge(status, endDate) {
    const now = new Date();
    const end = new Date(endDate);

    if (status === 'paid' && end > now) {
        return `<span class="status-badge active">Active</span>`;
    }
    if (status === 'paid' && end <= now) {
        return `<span class="status-badge expired">Expired</span>`;
    }

    let statusClass = (status || '').replace(/_/g, '-');
    let statusText = (status || 'unknown').replace(/_/g, ' ');

    return `<span class="status-badge ${statusClass}">${statusText}</span>`;
}

async function openPromotionRequestModal() {
    showLoader();
    try {
        const { data: products, error: productsError } = await db.from('products').select('id, title, image_url').eq('supplier_id', state.supplier.id);
        if (productsError) throw productsError;

        const { data: pricingOptions, error: pricingError } = await db.from('promotion_pricing').select('*').order('duration_days');
        if (pricingError) throw pricingError;
        promotionPricingOptions = pricingOptions;

        hideLoader();
        if (products.length === 0) {
            showConfirmation("You must have at least one product to create a promotion.", null, "No Products Found");
            return;
        }

        promotionRequestState = { step: 1, productId: null, productName: null, productImg: null, duration: null, price: null };
        const modal = document.getElementById('promotion-request-modal');
        modal.innerHTML = `
            <div class="modal" style="max-width: 700px;">
                <div id="promotion-modal-content"></div>
            </div>`;
        renderPromotionStep(1, products);
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('visible'), 10);

    } catch(err) {
        hideLoader();
        showConfirmation(`Error opening promotion request: ${err.message}`, null, 'Error');
    }
}

function renderPromotionStep(step, products) {
    const contentEl = document.getElementById('promotion-modal-content');
    let html = '';
    
    switch (step) {
        case 1:
            html = `<h2>Step 1: Select a Product to Promote</h2>
                    <div class="product-selection-list">
                    ${products.map(p => `
                        <div class="product-selection-item" onclick="selectPromotionProduct(this, ${p.id}, '${p.title.replace(/'/g, "\\'")}', '${p.image_url}')">
                            <img src="${p.image_url || 'https://via.placeholder.com/64'}">
                            <span>${p.title}</span>
                        </div>
                    `).join('')}
                    </div>
                    <div style="text-align:right; margin-top:20px;">
                        <button class="btn btn-secondary" onclick="closeModal('promotion-request-modal')">Cancel</button>
                        <button id="promo-step1-next" class="btn btn-primary" disabled onclick="renderPromotionStep(2)">Next</button>
                    </div>`;
            break;
        case 2:
            html = `<h2>Step 2: Choose Promotion Duration</h2>
                    <div class="pricing-grid">
                    ${promotionPricingOptions.map(opt => `
                        <div class="pricing-card" onclick="selectPromotionPricing(this, ${opt.duration_days}, ${opt.price})">
                            <h4>${opt.duration_days} Days</h4>
                            <p>PKR ${opt.price}</p>
                        </div>
                    `).join('')}
                    </div>
                    <div style="text-align:right; margin-top:20px;">
                         <button class="btn btn-secondary" onclick="openPromotionRequestModal()">Back</button>
                         <button id="promo-step2-next" class="btn btn-primary" disabled onclick="renderPromotionStep(3)">Next</button>
                    </div>`;
            break;
        case 3:
            html = `<h2>Step 3: Confirm and Submit</h2>
                    <div class="confirmation-summary">
                        <h4>Review Your Promotion Request</h4>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <img src="${promotionRequestState.productImg || 'https://via.placeholder.com/64'}" class="product-thumbnail">
                            <p><strong>Product:</strong> ${promotionRequestState.productName}</p>
                        </div>
                        <p><strong>Duration:</strong> ${promotionRequestState.duration} Days</p>
                        <p><strong>Total Price:</strong> PKR ${promotionRequestState.price}</p>
                    </div>
                    <p style="font-size: 0.9em; color: var(--text-light); margin-top: 15px;">By submitting, you agree to send this request to an administrator for approval. You will be notified when you can proceed with payment.</p>
                     <div style="text-align:right; margin-top:20px;">
                         <button class="btn btn-secondary" onclick="renderPromotionStep(2)">Back</button>
                         <button class="btn btn-primary" onclick="submitPromotionForApproval()">Submit for Approval</button>
                    </div>`;
            break;
    }
    contentEl.innerHTML = html;
}

function selectPromotionProduct(element, productId, productName, productImg) {
    document.querySelectorAll('.product-selection-item').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    promotionRequestState.productId = productId;
    promotionRequestState.productName = productName;
    promotionRequestState.productImg = productImg;
    document.getElementById('promo-step1-next').disabled = false;
}

function selectPromotionPricing(element, duration, price) {
    document.querySelectorAll('.pricing-card').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    promotionRequestState.duration = duration;
    promotionRequestState.price = price;
    document.getElementById('promo-step2-next').disabled = false;
}

async function submitPromotionForApproval() {
    showLoader("Submitting request for approval...");
    try {
        const startDate = new Date();
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + promotionRequestState.duration);

        const { error } = await db.from('promoted_products').insert({
            product_id: promotionRequestState.productId,
            supplier_id: state.supplier.id,
            start_date: startDate.toISOString(),
            end_date: endDate.toISOString(),
            payment_status: 'pending_approval',
            price_paid: promotionRequestState.price
        });

        if (error) throw error;
        
        closeModal('promotion-request-modal');
        showConfirmation("Your promotion request has been submitted. You will be notified once it is approved by the admin.", null, "Request Sent");
        await loadPromotions();

    } catch (err) {
        showConfirmation(`Error submitting request: ${err.message}`, null, 'Error');
    } finally {
        hideLoader();
    }
}

function showPaymentInfoModal(price) {
    const modal = document.getElementById('payment-info-modal');
    modal.innerHTML = `
        <div class="modal" style="max-width: 550px;">
            <div class="modal-content">
                <h2>Payment Instructions</h2>
                <p>To activate your promotion for <strong>PKR ${price}</strong>, please transfer the amount to one of the accounts below.</p>

                <div class="payment-account-card">
                    <h3><i class="fas fa-mobile-alt"></i> Jazz Cash</h3>
                    <p><strong>Account Name:</strong> Azher Mehmood</p>
                    <p><strong>Account Number:</strong> 03495643002</p>
                </div>

                <div class="payment-account-card">
                    <h3><i class="fas fa-sim-card"></i> Upaisa</h3>
                    <p><strong>Account Name:</strong> Azher Mehmood</p>
                    <p><strong>Account Number:</strong> 03348846378</p>
                </div>

                <div class="important-notice">
                    <p><i class="fas fa-exclamation-triangle"></i> <strong>Important:</strong> After you have paid, please contact the admin. Your promotion will become active only after the admin has confirmed your payment.</p>
                </div>

                <button class="btn btn-secondary" style="margin-top: 25px;" onclick="closeModal('payment-info-modal')">Close</button>
            </div>
        </div>
    `;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
}

function viewPromotionDetails(promotionId) {
    const promotion = state.promotions.find(p => p.id === promotionId);
    if (!promotion) {
        showConfirmation("Could not find promotion details.", null, 'Error');
        return;
    }
    const modal = document.getElementById('promotion-detail-modal');
    const duration = (new Date(promotion.end_date) - new Date(promotion.start_date)) / (1000 * 60 * 60 * 24);

    modal.innerHTML = `
        <div class="modal" style="max-width: 600px;">
            <h2>Promotion Details</h2>
            <div id="promotion-detail-modal-content">
                 <div class="detail-row" style="padding-top: 15px; flex-direction: column; align-items: center; gap: 15px; border-bottom: none;">
                    <img src="${promotion.product.image_url || 'https://via.placeholder.com/64'}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 12px; box-shadow: var(--shadow);">
                    <h3 style="margin: 0;">${promotion.product.title}</h3>
                 </div>
                 <div class="detail-row">
                    <span class="detail-label">Status</span>
                    <span>${renderPromotionStatusBadge(promotion.payment_status, promotion.end_date)}</span>
                 </div>
                 <div class="detail-row">
                    <span class="detail-label">Duration</span>
                    <span>${duration.toFixed(0)} Days</span>
                 </div>
                 <div class="detail-row">
                    <span class="detail-label">Promotion Price</span>
                    <span>PKR ${promotion.price_paid}</span>
                 </div>
                 <div class="detail-row">
                    <span class="detail-label">Start Date</span>
                    <span>${new Date(promotion.start_date).toLocaleString()}</span>
                 </div>
                 <div class="detail-row">
                    <span class="detail-label">End Date</span>
                    <span>${new Date(promotion.end_date).toLocaleString()}</span>
                 </div>
            </div>
             <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('promotion-detail-modal')">Close</button>
            </div>
        </div>
    `;
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('visible'), 10);
}
/* ---------- PROMOTIONS MANAGEMENT END ---------- */

/* ---------- CHAT PROFILE & ZOOM START ---------- */
function showImageModal(imageUrl) {
    const modal = document.getElementById('image-zoom-modal');
    modal.innerHTML = `
        <div class="image-zoom-content" onclick="event.stopPropagation();">
            <img src="${imageUrl}" alt="Profile Picture" onclick="this.classList.toggle('zoomed')">
            <button class="image-zoom-close-btn" onclick="closeImageModal()">&times;</button>
        </div>
    `;
    modal.classList.add('visible');
}

function closeImageModal() {
    const modal = document.getElementById('image-zoom-modal');
    modal.classList.remove('visible');
    setTimeout(() => { modal.innerHTML = ''; }, 300);
}

async function showUserProfilePage(userId) {
    showLoader();
    const mainContent = document.getElementById('main-content');
    const profilePage = document.getElementById('user-profile-page');
    try {
        const { data: user, error } = await db.from('users').select('first_name, last_name, brand_name, profile_pic').eq('id', userId).single();
        if (error) throw error;

        const displayName = (user.first_name && user.last_name && (user.first_name.trim() !== '' || user.last_name.trim() !== '')) 
                            ? `${user.first_name} ${user.last_name}`.trim() 
                            : user.brand_name;

        profilePage.innerHTML = `
            <div class="user-profile-page">
                <div class="profile-page-header">
                    <button class="btn btn-secondary" onclick="hideUserProfilePage()"><i class="fas fa-arrow-left"></i> Back to Chat</button>
                </div>
                <div class="profile-page-content">
                    <div class="profile-pic-large-container" onclick="if ('${user.profile_pic}') showImageModal('${user.profile_pic}');">
                        <img src="${user.profile_pic || 'https://via.placeholder.com/200'}" alt="User Profile" class="profile-pic-large">
                    </div>
                    <h2 class="user-profile-name">${displayName}</h2>
                </div>
            </div>
        `;

        mainContent.style.display = 'none';
        profilePage.style.display = 'block';

    } catch(err) {
        console.error("Error loading user profile:", err);
        showConfirmation(`Could not load user profile: ${err.message}`, null, 'Error');
    } finally {
        hideLoader();
    }
}

function hideUserProfilePage() {
    document.getElementById('main-content').style.display = 'block';
    const profilePage = document.getElementById('user-profile-page');
    profilePage.style.display = 'none';
    profilePage.innerHTML = '';
}
/* ---------- CHAT PROFILE & ZOOM END ---------- */


const handleImageUpload = (e) => { const files = e.target.files, previewsContainer = document.getElementById('image-previews'); for (let i=0; i<files.length; i++) { const file = files[i], total = newFiles.filter(f => f).length + previewsContainer.querySelectorAll('.preview-image-container[data-url]:not([data-removed="true"])').length; if (total >= 8) { showConfirmation('You can upload a maximum of 8 images.', null, 'Upload Limit'); break; } newFiles.push(file); const reader = new FileReader(); reader.onload = (event) => { const preview = document.createElement('div'); preview.className = 'preview-image-container'; const fileIndex = newFiles.length - 1; preview.innerHTML = `<img src="${event.target.result}" class="preview-image"><button type="button" class="delete-preview-btn" onclick="removeNewImage(this, ${fileIndex})">√ó</button>`; previewsContainer.appendChild(preview); }; reader.readAsDataURL(file); } e.target.value = ''; };
const removeNewImage = (btn, index) => { newFiles[index] = null; btn.parentElement.remove(); };
const removeExistingImage = (btn) => { const p = btn.parentElement; p.style.opacity = '0.5'; p.dataset.removed = 'true'; };

const handleVideoUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const MAX_SIZE = 60 * 1024 * 1024; // 60 MB
    if (file.size > MAX_SIZE) {
        showConfirmation('Video file is too large. Maximum size is 60 MB.', null, 'File Size Error');
        event.target.value = '';
        return;
    }
    newVideoFile = file;
    existingVideoUrl = null;
    const previewContainer = document.getElementById('video-preview-container');
    const videoURL = URL.createObjectURL(file);
    previewContainer.innerHTML = `<video src="${videoURL}" controls style="width: 100%; border-radius: 8px;"></video><button type="button" class="delete-preview-btn" onclick="removeVideoPreview()" style="top: 5px; right: 5px;">√ó</button>`;
};

const removeVideoPreview = () => {
    document.getElementById('video-preview-container').innerHTML = '';
    const fileInput = document.getElementById('product-video-file');
    if (fileInput) fileInput.value = '';
    newVideoFile = null;
    existingVideoUrl = null;
};

async function uploadVideoToCloudinary(file) {
  return new Promise((resolve, reject) => {
    const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`;
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    const xhr = new XMLHttpRequest();
    const progressContainer = document.getElementById('video-upload-progress');
    const progressBar = document.getElementById('video-progress-bar');
    progressContainer.style.display = 'block';
    xhr.open('POST', url, true);
    xhr.upload.onprogress = function(e) { if (e.lengthComputable) progressBar.value = (e.loaded / e.total) * 100; };
    xhr.onload = function() {
      progressContainer.style.display = 'none';
      if (xhr.status === 200) resolve(JSON.parse(xhr.responseText).secure_url);
      else reject(new Error('Upload failed'));
    };
    xhr.onerror = function() {
      progressContainer.style.display = 'none';
      reject(new Error('Upload error'));
    };
    xhr.send(formData);
  });
}

function renderProfilePicture(userOrSupplier, context) {
    const name = userOrSupplier?.brand_name || userOrSupplier?.full_name || userOrSupplier?.name || 'U';
    const picUrl = userOrSupplier?.profile_pic;
    const initial = name.charAt(0).toUpperCase();

    if (context === 'sidebar') {
        return '';
    }

    const previewId = context === 'account' ? 'account-profile-pic-preview' : '';
    const placeholderId = context === 'account' ? 'account-profile-pic-placeholder' : '';

    let imgHtml = `<img id="${previewId}" class="profile-pic-preview" style="display: none;" alt="Profile">`;
    let placeholderHtml = `<div id="${placeholderId}" class="profile-pic-placeholder" style="display: flex;">${initial}</div>`;

    if (picUrl) {
        imgHtml = `<img id="${previewId}" src="${picUrl}" class="profile-pic-preview" style="display: block;" alt="Profile">`;
        placeholderHtml = `<div id="${placeholderId}" class="profile-pic-placeholder" style="display: none;">${initial}</div>`;
    }
    
    if (context === 'chat') {
        if (picUrl) return `<img src="${picUrl}" alt="${name}">`;
        return `<span>${initial}</span>`;
    }
    
    return imgHtml + placeholderHtml;
}



function closeModal(modalId) {
    const modalOverlay = document.getElementById(modalId);
    if (modalOverlay) {
        modalOverlay.classList.remove('visible');
        setTimeout(() => {
            modalOverlay.style.display = 'none';
            modalOverlay.innerHTML = '';
        }, 300);
    }
}

function setupDraggableWhatsAppButton() {
    const fab = document.querySelector('.whatsapp-fab');
    let isDragging = false;
    let offsetX, offsetY;

    const move = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
        
        let newX = clientX - offsetX;
        let newY = clientY - offsetY;

        // Constrain to viewport
        const fabRect = fab.getBoundingClientRect();
        const max_X = window.innerWidth - fabRect.width;
        const max_Y = window.innerHeight - fabRect.height;
        
        newX = Math.max(0, Math.min(newX, max_X));
        newY = Math.max(0, Math.min(newY, max_Y));
        
        fab.style.left = `${newX}px`;
        fab.style.top = `${newY}px`;
        fab.style.right = 'auto'; // Override initial CSS
        fab.style.bottom = 'auto'; // Override initial CSS
    };

    const startDrag = (e) => {
        isDragging = true;
        const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
        const rect = fab.getBoundingClientRect();
        offsetX = clientX - rect.left;
        offsetY = clientY - rect.top;
        document.addEventListener('mousemove', move);
        document.addEventListener('touchmove', move, { passive: false });
    };

    const stopDrag = () => {
        isDragging = false;
        document.removeEventListener('mousemove', move);
        document.removeEventListener('touchmove', move);
    };

    fab.addEventListener('mousedown', startDrag);
    fab.addEventListener('touchstart', startDrag, { passive: false });

    document.addEventListener('mouseup', stopDrag);
    document.addEventListener('touchend', stopDrag);
}

// Make functions globally available
Object.assign(window, {
    showAddProductForm, editProduct, deleteProduct, viewOrderDetail, updateOrderStatus,
    handleImageUpload, removeNewImage, removeExistingImage, handleMessageKeypress, sendMessage, loadPayment,
    showWithdrawalModal, closeModal, openAttributesManager, saveAttributesFromModal, showAddPaymentMethodModal,
    openChatDetail, closeChatDetail, handleVideoUpload, removeVideoPreview, deleteOrder,
    previewImage, previewProfileImage, viewReviewDetail, handleAttributeChange, addCustomAttributePair,
    openVariantManager, filterColors, selectColor, renderSizeInputs, addVariantToList, removeVariant, saveVariantsAndClose,
    openPromotionRequestModal, renderPromotionStep, selectPromotionProduct, selectPromotionPricing, submitPromotionForApproval, showPaymentInfoModal, viewPromotionDetails,
    showImageModal, closeImageModal, showUserProfilePage, hideUserProfilePage, copyToClipboard, printInvoice,
    showDispatchModal, selectCourier, handleDispatchSubmit
});
</script>
</body>
</html>
